# Spec: PostGIS Service Detection and Sidecar Support

## Summary
Update K8s job generation to use PostGIS image and URL scheme, making it consistent with Docker Compose local execution. PostGIS is backward compatible with PostgreSQL, so this change benefits all projects without breaking existing ones.

## Requirements
- [ ] K8s dynamic job generation uses `postgis/postgis:16-3.4-alpine` image instead of `postgres:16-alpine`
- [ ] K8s dynamic job generation uses `postgis://` URL scheme instead of `postgres://`
- [ ] K8s reference template (`job-template.yaml`) updated for consistency (even though not used at runtime)
- [ ] Documentation reflects PostGIS support

## Edge cases
- [ ] Projects with `pg` gem and `adapter: postgis` - should work (primary use case)
- [ ] Projects with `pg` gem and `adapter: postgresql` - should continue to work (backward compatible)
- [ ] Detection failure fallback - should use PostGIS image (fail-open remains safe)

## Acceptance criteria
- [ ] K8s jobs for hriste project (uses PostGIS adapter) successfully run `rails db:prepare`
- [ ] K8s jobs for standard PostgreSQL projects still work correctly
- [ ] Local and remote execution produce consistent results (same database image/URL scheme)
- [ ] No additional detection logic needed (PostGIS used universally)

## Out of scope
- Database readiness checks (separate issue)
- Redis readiness checks (separate issue)
- MySQL or SQLite PostGIS equivalents
- Adapter-specific detection in database.yml (not needed - universal PostGIS works)

## Artifacts consulted
- workflow-design/WORKFLOW.md: Followed stage output patterns (spec as bd comment)
- lessons-learned.md: Applied learnings about documentation location (sandbox README, not root)

## Artifacts to update
- None (documentation updates are part of implementation)

## Technical approach (for planner)
The simplest solution is to use PostGIS image universally:
1. In `bin/claude-sandbox` function `generate_k8s_job_yaml()`:
   - Line 337: Change `postgres://` to `postgis://`
   - Line 361: Change `postgres:16-alpine` to `postgis/postgis:16-3.4-alpine`
2. In `k8s/job-template.yaml` (reference file):
   - Line 71: Change `postgres://` to `postgis://`
   - Line 100: Change `postgres:16-alpine` to `postgis/postgis:16-3.4-alpine`
3. Update README.md to mention PostGIS support in K8s section

## Open risks
None. PostGIS is fully backward compatible with PostgreSQL. The only cost is ~55MB larger image size.

## Files to modify
1. `/Users/tomas/.claude/claude-sandbox/bin/claude-sandbox` - Dynamic K8s job generation (lines 337, 361)
2. `/Users/tomas/.claude/claude-sandbox/k8s/job-template.yaml` - Reference template (lines 71, 100)
3. `/Users/tomas/.claude/claude-sandbox/README.md` - Documentation update
