# Context: K8s Dynamic Sidecar Generation (Phase 3)

## Request summary
Apply conditional service logic to Kubernetes job generation, similar to what was done for Docker Compose in Phase 2. The goal is to only include sidecar containers (postgres, redis) in K8s jobs when the target repository actually needs them, reducing resource waste and job startup time.

## Relevant code areas

### K8s Manifests
- `/Users/tomas/.claude/claude-sandbox/k8s/job-template.yaml` - Production job template with hardcoded sidecars (postgres, redis)
- `/Users/tomas/.claude/claude-sandbox/k8s/job-template-test.yaml` - Test template with sidecars commented out

### Launcher Scripts
- `/Users/tomas/.claude/claude-sandbox/bin/claude-sandbox` (lines 319-388) - `cmd_remote()` function that creates K8s jobs using `envsubst` for variable substitution
- `/Users/tomas/.claude/claude-sandbox/bin/detect-services.sh` - Pre-launch service detection (used by local command, not yet by remote)

### Container-side Detection
- `/Users/tomas/.claude/claude-sandbox/entrypoint.sh` (lines 166-236) - In-container service detection that exports NEEDS_POSTGRES, NEEDS_MYSQL, NEEDS_SQLITE, NEEDS_REDIS

### Docker Compose Reference (Phase 2 pattern)
- `/Users/tomas/.claude/claude-sandbox/docker-compose.yml` - Uses profiles: "with-postgres", "with-redis", "claude"
- `bin/claude-sandbox` (lines 269-286) - Profile detection logic for local command

## Existing patterns to follow

### Templating mechanism
Currently using `envsubst` for simple variable substitution:
```bash
# bin/claude-sandbox:383
envsubst < "$SANDBOX_DIR/k8s/job-template.yaml" | kubectl apply -f -
```

Variables substituted:
- `${TASK}`, `${JOB_NAME}`, `${CLAUDE_IMAGE}`, `${REPO_URL}`, `${REPO_BRANCH}`, `${DATABASE_NAME}`

### Service detection pattern (Phase 2)
```bash
# bin/claude-sandbox:270-285
if [ -x "$SANDBOX_DIR/bin/detect-services.sh" ]; then
  DETECTED_PROFILES=$("$SANDBOX_DIR/bin/detect-services.sh" "$REPO_URL" 2>/dev/null || echo "")
  if [ -n "$DETECTED_PROFILES" ]; then
    COMPOSE_PROFILES="$DETECTED_PROFILES"
  else
    # Detection failed, use safe defaults (all services)
    COMPOSE_PROFILES="claude with-postgres with-redis"
  fi
fi
```

### Fail-open fallback
Phase 2 established: if detection fails, start ALL services (better to over-provision than to fail).

## Technical constraints

### envsubst limitations
- `envsubst` only does simple string substitution
- Cannot conditionally include/exclude YAML sections
- Current template has sidecars hardcoded as array elements

### Current job-template.yaml structure
```yaml
spec:
  template:
    spec:
      containers:
      - name: claude
        # ... main container
      - name: postgres-sidecar   # Always included
        # ...
      - name: redis-sidecar      # Always included
        # ...
```

### Detection timing
Like Phase 2, detection must happen BEFORE job creation:
- `detect-services.sh` runs on the launcher machine
- git archive limitation: won't work for GitHub.com HTTPS URLs
- Falls back to checking local repo if in target directory

## Edge cases to address

1. **Detection fails (git archive not supported)**: Fall back to all sidecars (fail-open)
2. **No services needed**: Generate job with only claude container
3. **Only postgres needed**: Generate job with claude + postgres-sidecar
4. **Only redis needed**: Generate job with claude + redis-sidecar
5. **Both needed**: Generate job with all containers (current behavior)
6. **MySQL detected**: Currently no MySQL sidecar exists - should this be added or logged?
7. **SQLite detected**: No sidecar needed, but should be logged

## Risks

### Technical risks
1. **YAML manipulation complexity**: Conditionally including YAML sections is harder than Docker Compose profiles
2. **Template maintainability**: Multiple templates or complex templating could become hard to maintain
3. **MySQL support gap**: Detection supports MySQL but no MySQL sidecar exists

### Approach tradeoffs

| Approach | Pros | Cons |
|----------|------|------|
| **Multiple static templates** | Simple, clear | Template duplication, maintenance burden |
| **envsubst with bash preprocessing** | Uses existing tool | Hacky, error-prone YAML manipulation |
| **yq/jq for YAML manipulation** | Powerful, clean | New dependency, complex commands |
| **Kustomize overlays** | K8s-native, composable | Significant restructuring |
| **Helm chart** | Industry standard, flexible | Overkill for this use case |

## Artifacts consulted

- `workflow-design/WORKFLOW.md`: Used - provides stage output patterns and artifact handling guidance
- `lessons-learned.md`: Used - key insights:
  - Phase 1 (.claude-53k): Multi-phase features benefit from explicit interface contracts (NEEDS_POSTGRES, etc.)
  - Phase 2 (.claude-4nq): Timing paradox - detection must happen pre-launch, not in-container
  - Phase 2 (.claude-4nq): Fallback chain design - empty detection -> all services

## Artifacts requiring update
- `claude-sandbox/README.md` - Document dynamic K8s sidecar configuration (parallel to Docker Compose docs)
- `claude-sandbox/k8s/TESTING.md` - Update testing guide for conditional sidecars
