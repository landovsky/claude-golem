# Context: PostGIS Service Detection and Sidecar Support

## Request summary

The hriste project uses `adapter: postgis` in `config/database.yml` instead of the standard PostgreSQL adapter. Projects using PostGIS require:
1. The `postgis/postgis` Docker image (not plain `postgres`)
2. A `postgis://` URL scheme for Rails activerecord-postgis-adapter to work correctly

Currently, Docker Compose local runs work because they already use PostGIS, but K8s remote runs fail because they use plain PostgreSQL.

## Relevant code areas

### Service Detection
- `/Users/tomas/.claude/claude-sandbox/bin/detect-services.sh` - Pre-launch service detection script (runs before containers start)
  - Lines 17-25: Detects `pg` gem in Gemfile for local repos
  - Lines 58-66: Detects `pg` gem via git archive for remote repos
  - Does NOT detect PostGIS adapter from database.yml

- `/Users/tomas/.claude/claude-sandbox/entrypoint.sh` - Runtime detection (inside container)
  - Lines 166-236: Service detection section
  - Lines 174-180: PostgreSQL detection via `pg` gem in Gemfile
  - Does NOT check database.yml for adapter type
  - Does NOT have a `NEEDS_POSTGIS` flag

### Docker Compose (Local)
- `/Users/tomas/.claude/claude-sandbox/docker-compose.yml`
  - Line 12: Already uses `postgis/postgis:16-3.4-alpine` image
  - Line 40: Already uses `postgis://` URL scheme
  - Status: **Already works for PostGIS projects**

### K8s Dynamic Generation (Remote)
- `/Users/tomas/.claude/claude-sandbox/bin/claude-sandbox`
  - Lines 319-458: `generate_k8s_job_yaml()` function - generates K8s YAML dynamically
  - Line 337: Uses `postgres://` URL scheme (not postgis://)
  - Line 361: Uses `postgres:16-alpine` image (not postgis/postgis)
  - Status: **Does NOT support PostGIS**

### K8s Reference Template
- `/Users/tomas/.claude/claude-sandbox/k8s/job-template.yaml`
  - Line 71: Uses `postgres://` URL scheme
  - Line 100: Uses `postgres:16-alpine` image
  - Note: This is a reference file only; actual jobs use dynamic generation
  - Status: **Does NOT support PostGIS**

## Existing patterns to follow

### Profile-based service selection
The existing pattern uses string profiles like `"with-postgres"` and `"with-redis"`:
- `detect-services.sh` returns space-separated profiles
- `cmd_local()` parses profiles to build Docker Compose `--profile` flags
- `cmd_remote()` parses profiles to set boolean flags for YAML generation

### Detection pattern
```bash
# Pattern from detect-services.sh line 18
if grep -q "gem ['\"]pg['\"]" "$PWD/Gemfile" 2>/dev/null; then
  profiles="$profiles with-postgres"
fi
```

### Conditional sidecar generation
The `generate_k8s_job_yaml()` function takes boolean flags and conditionally includes sidecars:
```bash
if [ "$needs_postgres" = "true" ]; then
  sidecars="${sidecars}
    # Sidecar: Postgres
    ..."
fi
```

## Technical constraints

1. **Detection timing**:
   - `detect-services.sh` runs BEFORE container/job starts (has repo access via git archive or local clone)
   - `entrypoint.sh` runs INSIDE container AFTER services are already provisioned
   - PostGIS detection must happen in `detect-services.sh` to affect service provisioning

2. **Backward compatibility**:
   - PostGIS is a superset of PostgreSQL - projects not using PostGIS work fine with PostGIS image
   - Using PostGIS image universally is the simplest approach

3. **URL scheme matters**:
   - Rails `activerecord-postgis-adapter` requires `postgis://` scheme in DATABASE_URL
   - Plain `postgres://` scheme will fail with PostGIS adapter

4. **Image size**:
   - `postgres:16-alpine` is ~235MB
   - `postgis/postgis:16-3.4-alpine` is ~290MB
   - Acceptable difference for full compatibility

## Edge cases to address

1. **Project with `pg` gem but `adapter: postgis` in database.yml**
   - Current: Detected as needing Postgres (correct), but wrong image/URL used in K8s
   - Solution: Always use PostGIS image and URL (backward compatible)

2. **Project with `pg` gem and standard `adapter: postgresql`**
   - Current: Works locally (PostGIS image), but fails remotely (plain Postgres image)
   - Solution: Use PostGIS image everywhere for consistency

3. **Detection fails (GitHub.com HTTPS URL)**
   - Current: Falls back to all sidecars with plain Postgres
   - Solution: Fall back should use PostGIS image

## Risks

1. **Technical**: PostGIS image is slightly larger (~55MB more), but this is acceptable for universal compatibility.

2. **Breaking change**: None. PostGIS is backward compatible with PostgreSQL.

3. **Documentation**: Need to update README.md to reflect PostGIS support.
