# Context: Authentication Error Handling in Claude Sandbox

## Request summary
Authentication failures (e.g., "Invalid API key") fail silently instead of surfacing errors to users. The error message "Invalid API key - Fix external API key" appears when running `claude -p` manually in the container, but this never reaches users in normal operation.

## Relevant code areas

### Primary: entrypoint.sh (lines 49-54, 251-257)
- `/workspace/claude-sandbox/entrypoint.sh`
- **Lines 49-54**: Pre-flight authentication validation - checks if either `CLAUDE_CODE_OAUTH_TOKEN` or `ANTHROPIC_API_KEY` is set
- **Lines 251-257**: Claude execution - uses `exec claude ... | jq ...` which pipes output through jq, filtering for only `text_delta` events

### Secondary: bin/claude-sandbox (lines 129-159, 161-193)
- `/workspace/claude-sandbox/bin/claude-sandbox`
- **Lines 129-159**: `check_env()` - validates env vars before starting container
- **Lines 161-193**: `cmd_local()` - runs docker compose with environment variables

### Supporting: notify-telegram.sh
- `/workspace/claude-sandbox/notify-telegram.sh`
- Reports exit code but not the reason for failure

## Existing patterns to follow

### Error reporting pattern (entrypoint.sh lines 14-21)
```bash
log() { echo -e "${GREEN}[sandbox]${NC} $1"; }
error() { echo -e "${RED}[sandbox]${NC} $1"; }
```
Currently used for pre-flight checks but not for Claude runtime errors.

### Exit code handling (entrypoint.sh lines 24-36)
```bash
cleanup() {
  EXIT_CODE=$?
  if [ $EXIT_CODE -eq 0 ]; then
    success "Session completed successfully"
  else
    error "Session ended with exit code: $EXIT_CODE"
  fi
  /usr/local/bin/notify-telegram.sh "$EXIT_CODE"
}
trap cleanup EXIT
```
Captures exit code but loses the actual error message.

## Technical constraints

1. **jq filter is the root cause**: The pipeline `| jq -rj 'select(.type == "stream_event" and .event.delta.type? == "text_delta") | .event.delta.text'` filters output to show ONLY successful text streaming events. Authentication errors come in different event types and are silently dropped.

2. **exec replaces shell**: Using `exec claude ...` means the entrypoint.sh process is replaced - no opportunity for post-processing the exit.

3. **stream-json format**: The `--output-format stream-json` produces newline-delimited JSON objects. Error events have a different structure than text deltas.

## Edge cases to address

1. **Invalid API key** - Current: silent failure. Expected: show "Invalid API key" message.
2. **Expired OAuth token** - Current: silent failure. Expected: show expiration message and suggest `claude setup-token`.
3. **Rate limiting** - Current: unknown. Expected: show rate limit message.
4. **Network errors** - Current: unknown. Expected: show connectivity error.
5. **Invalid token format** - Current: likely silent. Expected: show format validation error.

## Risks

1. **Unknown error event structure**: We don't have documentation on what the stream-json error event format looks like. May need to test with invalid credentials to capture the format.
2. **Multiple error types**: Authentication can fail for different reasons (invalid, expired, malformed, rate-limited). Each may have a different event type.
3. **Backward compatibility**: The jq filter change must not break normal text streaming output.
