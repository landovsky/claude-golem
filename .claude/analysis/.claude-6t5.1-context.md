# Context: OTLP Integration for Workflow Metrics

## Request summary

Replace mock/null token values in Phase 1's workflow metrics with real OTLP (OpenTelemetry) data from Claude Code's monitoring API. This is a drop-in replacement - same JSONL schema, same bd comments format, just real values instead of nulls.

## Relevant code areas

- `/Users/tomas/.claude/hooks/metrics-start.sh` - SubagentStart hook, writes stage_start events to JSONL. Currently writes `model: null`.
- `/Users/tomas/.claude/hooks/metrics-end.sh` - SubagentStop hook, writes stage_end events with null token values and cost. Builds bd comments with placeholder text.
- `/Users/tomas/.claude/workflow-metrics.jsonl` - JSONL storage for metrics events

## Key Finding: OTLP Metrics Are NOT Available in Hooks

After reviewing Claude Code's documentation thoroughly, I discovered a critical architectural constraint:

**OTLP metrics are exported asynchronously via OpenTelemetry's standard protocols (gRPC/HTTP) to external collectors. They are NOT available as environment variables, files, or stdin data in hook scripts.**

The hooks documentation (https://code.claude.com/docs/en/hooks) shows that SubagentStop hooks receive only:
- `session_id`
- `transcript_path`
- `cwd`
- `permission_mode`
- `hook_event_name`
- `stop_hook_active`
- `agent_id`
- `agent_type`
- `agent_transcript_path`

There is NO token usage data passed to hooks. The OTLP monitoring system operates independently - it exports metrics to configured backends (Prometheus, OTLP collectors, console) but does not expose this data to hooks.

## Existing patterns to follow

From Phase 1 (`/Users/tomas/.claude/hooks/metrics-end.sh`):
- jq for safe JSON generation
- `set +e` and `|| true` for error tolerance
- BSD/GNU date fallback chain for portability
- Conditional bd comment posting based on task ID format

## Technical constraints

1. **No direct OTLP access from hooks**: Hook scripts cannot read OTLP metrics. The telemetry system exports data to external collectors only.

2. **Transcript files contain API usage data**: The `agent_transcript_path` in SubagentStop hooks points to a JSONL transcript that DOES contain API usage information. This is the viable data source.

3. **Transcript format**: Each line in the transcript is a JSON object. API usage events include token counts and cost data in `claude_code.api_request` events.

4. **Model pricing required**: Cost calculation needs model-to-price mapping. Current pricing:
   - Claude Opus 4.5: $5/$25 per MTok (input/output)
   - Claude Sonnet 4.5: $3/$15 per MTok (input/output)
   - Claude Haiku 4.5: $1/$5 per MTok (input/output)
   - Cache reads: 0.1x input price
   - Cache creation (5m): 1.25x input price

## Alternative Approach: Parse Transcript for Usage

The `agent_transcript_path` provided to SubagentStop hooks contains the subagent's conversation transcript in JSONL format. Claude Code logs API request events there that include token usage.

From the monitoring docs, API request events contain:
```
"input_tokens": Number of input tokens
"output_tokens": Number of output tokens
"cache_read_tokens": Number of tokens read from cache
"cache_creation_tokens": Number of tokens used for cache creation
"cost_usd": Estimated cost in USD
"model": Model used (e.g., "claude-sonnet-4-5-20250929")
```

The hook can parse this transcript to extract and sum token usage.

## Edge cases to address

1. **Transcript file may not exist** - Hook should handle gracefully, use null values
2. **No API calls in subagent** - Some subagents might have zero usage (edge case)
3. **Multiple API calls per subagent** - Sum all token counts, sum all costs
4. **Model may vary within subagent** - Rare but possible; capture last model used
5. **Partial transcript** - Subagent may be interrupted before final usage is logged

## Risks

1. **Transcript format not documented**: The exact JSONL structure of transcripts is not publicly documented. Need to examine actual transcript files to confirm field names.
2. **Transcript parsing performance**: Large transcripts may slow down hooks. Should use streaming/grep for efficiency.
3. **Format stability**: Transcript format could change in future Claude Code versions.
4. **Cost already calculated**: API request events include `cost_usd` directly, so we may not need to calculate from tokens. Verify this field is populated.
