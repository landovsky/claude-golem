# Context: Usage Metrics Collection (Phase 1)

## Request summary
Implement Phase 1 of a usage metrics collection system to track token usage per beads task and per workflow stage (analyst, planner, implementer, reviewer). Phase 1 implements the FULL persistence pipeline with mock token data - validating the entire flow so Phase 2 is a drop-in replacement with real OTLP data.

## Relevant code areas

### Workflow System
- `/Users/tomas/.claude/agents/master.md` - Main orchestrator that creates subtasks and invokes agents via Task tool
- `/Users/tomas/.claude/agents/analyst.md` - Uses Opus model, creates specs
- `/Users/tomas/.claude/agents/planner.md` - Uses Sonnet model, creates plans
- `/Users/tomas/.claude/agents/implementer.md` - Uses Sonnet model, writes code
- `/Users/tomas/.claude/agents/reviewer.md` - Reviews and captures lessons
- `/Users/tomas/.claude/commands/develop.md` - Entry point for development workflow

### Beads Integration
- `/Users/tomas/.claude/.beads/issues.jsonl` - Git-backed issue storage
- `bd comments add [id] "[text]"` - Primary mechanism for agent output
- `bd show [id]` - Task retrieval for downstream agents

### Settings & Hooks
- `/Users/tomas/.claude/settings.json` - Existing hooks: SessionStart, PreCompact, Notification

## Existing patterns to follow

### BD Comments for Stage Output
From `agents/planner.md` lines 51-93:
```bash
bd comments add [task-id] "$(cat <<'EOF'
# Plan: [title]
...
EOF
)"
```
This HEREDOC pattern is used consistently across agents for writing structured output.

### JSONL for Persistent Data
The beads system uses JSONL format for git-friendly persistence:
- `/Users/tomas/.claude/.beads/issues.jsonl`
- `/Users/tomas/.claude/.beads/interactions.jsonl`

### Hook Configuration
From `/Users/tomas/.claude/settings.json`:
```json
{
  "hooks": {
    "SessionStart": [{ "hooks": [{ "command": "bd prime", "type": "command" }] }]
  }
}
```

## Technical constraints

### 1. OpenTelemetry is the Official Monitoring API
From Claude Code documentation (https://code.claude.com/docs/en/monitoring-usage):
- Environment variables: `CLAUDE_CODE_ENABLE_TELEMETRY=1`
- Metrics: `claude_code.token.usage` (with type: input/output/cacheRead/cacheCreation)
- Metrics: `claude_code.cost.usage` (in USD)
- Events: `claude_code.api_request` (includes input_tokens, output_tokens, cache_read_tokens, cost_usd, duration_ms, model)
- All metrics include `session.id` attribute

### 2. Claude Code Hooks System
From hooks documentation, available lifecycle hooks:
- `SubagentStart`: Fires when Task tool spawns subagents - provides agent_id, agent_type
- `SubagentStop`: Fires when subagent finishes - provides agent_id, agent_type, agent_transcript_path
- `Stop`: Fires when main agent finishes responding
- `SessionStart`/`SessionEnd`: Session lifecycle

### 3. Key Insight: Custom Agent Names in Hooks
From hooks documentation: "Supports matchers to filter by agent type name (built-in agents like Bash, Explore, Plan, or **custom agent names** from `.claude/agents/`)"

This means our agents (analyst, planner, implementer, reviewer) should appear as agent_type values in the hooks.

### 4. JSONL Write Performance
From evaluation doc: "Append-only writes are fast; rotate files monthly" - JSONL is appropriate.

### 5. Git Persistence Requirement
All data must be in git-tracked files for remote execution. The `.claude/` directory is already established.

### 6. $TASK Environment Variable
Decision: Use `$TASK` (capped at 50 chars) as the task identifier for metrics correlation. Master agent sets this before invoking subagents.

## Edge cases to address

1. **Fast-track tasks**: Master handles end-to-end without subagents - these won't trigger SubagentStart/Stop hooks
2. **Task splits**: Analyst may convert task to epic - each stage gets its own metrics entry
3. **Blocked tasks**: Agent may block mid-execution - SubagentStop still fires, capture status
4. **Session interruption**: User may abort - partial metrics should be recorded
5. **Missing $TASK**: Hook should handle gracefully with fallback value
6. **$TASK exceeds 50 chars**: Truncate to maintain clean data

## Risks

### Technical Risks
1. **Custom agent name verification needed**: Must confirm our agent names (analyst, planner, etc.) appear correctly in hooks as agent_type.
2. **Environment variable propagation**: Must verify $TASK is accessible in hook scripts when set by master.
3. **Hook script reliability**: Scripts must be robust to malformed JSON and exit 0 on errors.

### Mitigations
1. Test with one manual workflow before full integration
2. Add explicit export of TASK in master before Task tool calls
3. Wrap all JSON parsing in error handling with fallbacks
