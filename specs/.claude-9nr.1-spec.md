# Spec: Fix inter-stage data passing in development workflow

## Summary
Replace the unreliable file-based handoff between workflow stages with a return-value relay pattern where the master orchestrator captures each sub-agent's structured output and passes it in the prompt to the next agent. This eliminates filesystem coordination failures between Task tool sub-agents.

## Background: Why files fail

Three root causes identified:
1. **Planner cannot write files** -- its declared toolset (`Read, Glob, Grep`) excludes `Write` and `Bash`, making file output impossible.
2. **CWD instability** -- sub-agent bash calls reset CWD, causing path mismatches between writer and reader.
3. **Side-effect fragility** -- relying on filesystem side-effects from ephemeral sub-agents is inherently unreliable. The Task tool's primary reliable channel is its return value.

## Approach evaluation

Four approaches were evaluated:

| Approach | Reliability | Simplicity | Size handling | Discoverability |
|----------|-------------|------------|---------------|-----------------|
| **A: bd comments** | Medium -- depends on CLI availability and size limits | Medium -- requires ID passing | Unknown limits, risk of truncation | Good -- comments visible in bd show |
| **B: Master as relay** | **High** -- uses Task tool's native return channel | **High** -- no external dependencies | Bounded by context window (large) | Low -- ephemeral, lives in conversation |
| **C: Scratchpad directory** | Low -- same filesystem problems | Medium | No limits | Good -- files on disk |
| **D: Files + relay hybrid** | Medium | Low -- two mechanisms | Good | Good |

**Recommended: Approach B (master as relay)** with files as optional secondary output.

Rationale:
- The Task tool reliably returns the sub-agent's final text to the caller. This is the one guaranteed data channel.
- No external dependency (bd CLI, filesystem).
- Master already sits between every stage -- it just needs to capture and forward.
- Solves the planner problem immediately (planner returns its plan as text, no Write tool needed).
- Files become optional artifacts (nice to have for humans browsing the repo) rather than the critical data path.

## Requirements

- [ ] Each agent's instructions must specify that the agent's primary output is its **final text response**, formatted as a structured markdown document (the spec, plan, review notes, etc.)
- [ ] Master must capture each sub-agent's return value and include it verbatim in the prompt to the next agent
- [ ] Master must stop using file-existence checks as the gate between stages; instead, validate that the sub-agent returned non-empty structured content
- [ ] Agent instructions must still encourage writing files as a secondary action (for human discoverability), but the workflow must not depend on file writes succeeding
- [ ] The planner agent's toolset contradiction must be resolved: either add Write tool, or remove the file-write requirement (the relay approach makes this optional)
- [ ] Master's handoff to each agent must include all upstream outputs (e.g., implementer receives both the spec text and the plan text)

## Edge cases

- [ ] Sub-agent returns empty or malformed output -- master must detect this and retry once before blocking
- [ ] Very large outputs (200+ lines) -- these fit comfortably in the context window; no special handling needed, but master should not add unnecessary commentary around relayed content
- [ ] Agent blocks mid-work -- blocker reason should still go to bd comments (this already works); the relay pattern only applies to successful stage outputs
- [ ] Fast-track path -- no change needed; master already handles everything inline

## Acceptance criteria

- [ ] A full 4-stage workflow (analyst -> planner -> implementer -> reviewer) completes successfully with each stage receiving its required upstream context
- [ ] The workflow succeeds even if no `.claude/specs/`, `.claude/plans/`, or `.claude/analysis/` files are written to disk
- [ ] Planner can produce its plan output without needing the Write tool
- [ ] Master validates stage output by checking the returned text, not filesystem
- [ ] All 5 agent definition files are updated to reflect the new primary output mechanism
- [ ] WORKFLOW.md artifact is updated to document the relay pattern

## Out of scope

- Changing the bd task tracker or its comment system
- Modifying how the Task tool itself works
- Adding persistent storage or database for stage outputs
- Changing the agent roles or workflow sequence
- Optimizing token usage from relaying large documents

## Artifacts consulted
- `artifacts/workflow-design/WORKFLOW.md` (usage: always) -- documents current file-based handoff architecture; confirms file outputs are the defined contract between agents

## Artifacts to update
- `artifacts/workflow-design/WORKFLOW.md` -- must update "File Outputs" section to reflect that files are secondary/optional; add "Data Flow" section documenting the relay pattern

## Open risks
- Token cost increases as master's context grows with relayed content across 4 stages. For a typical workflow, this adds roughly 1000-2000 tokens per relay. Acceptable but worth monitoring.
- If Claude Code changes Task tool behavior (e.g., truncating return values), the relay would need revisiting. This is unlikely since return values are the primary interface.
