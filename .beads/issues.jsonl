{"id":".claude-2ef","title":"Test bd comment size limits","description":"Throwaway task to test large comment handling","status":"tombstone","priority":3,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T10:09:36.359512+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T12:15:56.838194+01:00","deleted_at":"2026-01-31T12:15:56.838194+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":".claude-2uo","title":"Fix inter-agent data flow and bd handling issues","description":"Review identified 2 critical, 4 major, and 3 minor issues in workflow agents.\n\n## Critical\n1. Planner Input section lists file path as primary but Phase 1 says bd is primary - inconsistent\n2. Master describes what task IDs to pass but not HOW to pass them to agents\n\n## Major\n1. Inconsistent fallback behavior - Input sections contradict Phase 1 instructions across agents\n2. Analyst uses [own-task-id] for comments but [issue-id] for closing - unclear distinction\n3. No agent shows bd commit command - unclear if auto-commit or missing\n4. Master validation doesn't specify what constitutes valid output in bd comments\n\n## Minor\n1. Implementer bd comment is optional but master expects to validate output exists\n2. Inconsistent variable naming: [issue-id] vs [own-task-id] vs [task-id]\n3. Reviewer Phase 1 mixes comment-in-code-block format\n\n## Recommendations\n1. Add explicit handoff protocol to master.md with invocation syntax\n2. Standardize variable naming across all agents\n3. Update Input sections to match Phase 1 behavior\n4. Clarify implementer output expectations\n5. Document bd commit semantics","status":"closed","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T15:42:47.103289+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T21:15:13.614972+01:00","closed_at":"2026-01-28T21:15:13.614972+01:00","close_reason":"Fixed all 6 issues: bd show→bd comments, standardized Input sections, added invocation syntax, unified [task-id] naming, fixed reviewer formatting, added validation criteria","comments":[{"id":1,"issue_id":".claude-2uo","author":"Tomáš Landovský","text":"Blocked: Need to determine bd commit semantics before proceeding. Check if bd auto-commits or requires explicit commit command.","created_at":"2026-01-28T14:42:51Z"},{"id":2,"issue_id":".claude-2uo","author":"Tomáš Landovský","text":"## Resolution: Use `bd comments` instead of `bd show`\n\nKey finding: The token bloat issue is solved by using `bd comments [task-id]` instead of `bd show [task-id]`.\n\n| Command | Returns |\n|---------|---------|\n| `bd show task-123` | Full task description + comments (bloat) |\n| `bd comments task-123` | Just comments (lean) |\n\nThis eliminates the CWD/file-path problem entirely since bd uses its own database.\n\n### Updated fix list:\n1. Replace `bd show` with `bd comments` for reading upstream output\n2. Standardize Input sections to reflect bd-primary (remove file-first language)\n3. Add explicit agent invocation syntax to master.md\n4. Standardize variable naming: use `[task-id]` consistently\n5. Fix reviewer Phase 1 code block formatting (comments outside code blocks)\n6. Clarify output validation criteria in master.md","created_at":"2026-01-28T20:12:58Z"}]}
{"id":".claude-46d","title":"Implementer does not create/checkout planned branch","description":"Facts from this run:\n\n1. Plan specified branch: feature/hriste-4j5-cancancan-modular-authorization (line 16 of plan)\n2. Actual branch used: feature/manufacture-domain (the branch that was already checked out at session start)\n3. No new branch was created: The implementer sub-agent committed directly to the existing branch without creating or checking out the planned branch\n4. Commits made:\n   - 1d8159ee feat: implement modular CanCanCan authorization with financial_controller role (implementer)\n   - caa68755 fix: Register user_role_selector Stimulus controller (review) (reviewer)\n\nGap: The implementer agent did not follow the branch name from the plan. It worked on whatever branch was current when the task started. The planner wrote a branch name but there was no handoff mechanism to ensure the implementer actually created/used it.","status":"open","priority":2,"issue_type":"bug","owner":"landovsky@gmail.com","created_at":"2026-01-29T07:21:13.405933+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-29T07:21:13.405933+01:00"}
{"id":".claude-5zv","title":"test throwaway task for comment testing","status":"tombstone","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T10:10:54.209361+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:12:11.859925+01:00","comments":[{"id":3,"issue_id":".claude-5zv","author":"Tomáš Landovský","text":"This is a multi-line test comment to verify bd comments can handle:\n- Complex formatting\n- Multiple paragraphs\n- Special characters: @#$%^\u0026*()\n- Code blocks:\n  ```bash\n  echo \"test\"\n  ```\n- Long content that spans many lines\n\nThis would represent a spec or plan document that needs to be passed between stages.\nThe content includes markdown, code, and various formatting to ensure robustness.\n\n## Section Headers\n### Subsections\n- Bullet points\n- More bullets\n\n1. Numbered lists\n2. Second item\n\n\u003e Blockquotes\n\u003e Multiple lines\n\n**Bold text** and *italic text* and `inline code`.\n\nEnd of test content.","created_at":"2026-01-28T09:11:43Z"}],"deleted_at":"2026-01-28T10:12:11.859925+01:00","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":".claude-6td","title":"Remove duplicate Postgres configuration","description":"Both init container and postgres-sidecar define identical Postgres config. Redundant and confusing. Solution: Keep only sidecar configuration.","status":"open","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-31T17:48:09.889088+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:48:09.889088+01:00"}
{"id":".claude-8bp","title":"Transform claude-sandbox to global command with auto-detection","description":"Transform claude-sandbox to global command with auto-detection","status":"closed","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-31T11:31:25.657338+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T11:41:49.495777+01:00","closed_at":"2026-01-31T11:41:49.495777+01:00","close_reason":"Closed","comments":[{"id":4,"issue_id":".claude-8bp","author":"Tomáš Landovský","text":"## Plan: Transform claude-sandbox to Global Command\n\n### Overview\n\nCurrently, claude-sandbox is a project-specific tool that derives all paths from its own location and requires hardcoded configuration. We need to transform it into a globally callable command that auto-detects repository context from the current working directory, similar to how git commands work from any project directory.\n\nThe key insight is that the script should locate the ~/.claude/claude-sandbox installation directory (where Docker files live) independently from where it's called, while auto-detecting the target repository from the current directory's git configuration.\n\n### Branch\nfeature/global-sandbox-command\n\n### Key Patterns to Follow\n\n- /Users/tomas/.claude/commands/sandbox.md - Shows the intended auto-detection pattern (git remote discovery)\n- /Users/tomas/.claude/claude-sandbox/bin/claude-sandbox - Current implementation with path derivation (lines 25-27)\n- /Users/tomas/.claude/claude-sandbox/docs/docker-gotchas.md - Documents all lessons learned about the sandbox\n\n### Files to Change\n\n- /Users/tomas/.claude/claude-sandbox/bin/claude-sandbox - Main script path resolution and auto-detection logic\n- /Users/tomas/.claude/claude-sandbox/docker-compose.yml - Make database name configurable via environment variable\n- /Users/tomas/.claude/claude-sandbox/README.md - Update installation and usage documentation\n- /Users/tomas/.claude/claude-sandbox/entrypoint.sh - No changes needed (already uses REPO_URL from env)\n- /Users/tomas/.claude/claude-sandbox/.gitignore - Document .env file pattern for local config\n\n### Implementation Details\n\n#### 1. Path Resolution Strategy (bin/claude-sandbox)\n\nCurrent approach (lines 25-27):\n```bash\nSCRIPT_DIR=\"\\$(cd \\\"\\$(dirname \\\"\\${BASH_SOURCE[0]}\\\")\\\" \u0026\u0026 pwd)\"\nPROJECT_DIR=\"\\$(dirname \\\"\\$SCRIPT_DIR\\\")\"\nSANDBOX_DIR=\"\\$PROJECT_DIR\"\n```\n\nNew approach:\n```bash\n# Find the sandbox installation directory\n# Try: script's parent dir (backward compat), then ~/.claude/claude-sandbox (global install)\nSCRIPT_DIR=\"\\$(cd \\\"\\$(dirname \\\"\\${BASH_SOURCE[0]}\\\")\\\" \u0026\u0026 pwd)\"\nCANDIDATE_DIR=\"\\$(dirname \\\"\\$SCRIPT_DIR\\\")\"\n\nif [ -f \"\\$CANDIDATE_DIR/docker-compose.yml\" ]; then\n  # Called from bin/ subdirectory (backward compatible)\n  SANDBOX_DIR=\"\\$CANDIDATE_DIR\"\nelif [ -f \"\\$HOME/.claude/claude-sandbox/docker-compose.yml\" ]; then\n  # Global installation\n  SANDBOX_DIR=\"\\$HOME/.claude/claude-sandbox\"\nelse\n  error \"Cannot find claude-sandbox installation\"\n  error \"Expected docker-compose.yml in:\"\n  error \"  - \\$CANDIDATE_DIR\"\n  error \"  - \\$HOME/.claude/claude-sandbox\"\n  exit 1\nfi\n```\n\n#### 2. Auto-Detection Logic (bin/claude-sandbox)\n\nAdd after path resolution, before check_env():\n\n```bash\n# Auto-detect REPO_URL from current directory if not set\nauto_detect_repo() {\n  if [ -n \"\\$REPO_URL\" ]; then\n    # Explicitly set, don't override\n    return 0\n  fi\n\n  # Try to get git remote from current directory\n  local detected_url=\\$(git -C \"\\$PWD\" remote get-url origin 2\u003e/dev/null)\n  if [ -z \"\\$detected_url\" ]; then\n    error \"REPO_URL not set and cannot auto-detect from current directory\"\n    error \"Either:\"\n    error \"  1. Run from a git repository with origin remote, or\"\n    error \"  2. Set REPO_URL environment variable\"\n    return 1\n  fi\n\n  export REPO_URL=\"\\$detected_url\"\n  log \"Auto-detected REPO_URL: \\$REPO_URL\"\n}\n\n# Auto-detect REPO_BRANCH from current directory if not set\nauto_detect_branch() {\n  if [ -n \"\\$REPO_BRANCH\" ]; then\n    # Explicitly set, don't override\n    return 0\n  fi\n\n  # Try to get current branch from current directory\n  local detected_branch=\\$(git -C \"\\$PWD\" branch --show-current 2\u003e/dev/null)\n  if [ -n \"\\$detected_branch\" ]; then\n    export REPO_BRANCH=\"\\$detected_branch\"\n    log \"Auto-detected REPO_BRANCH: \\$REPO_BRANCH\"\n  else\n    # Default to main (already handled by entrypoint.sh default)\n    log \"Using default branch: main\"\n  fi\n}\n```\n\nModify check_env() to call auto-detection BEFORE validating REPO_URL:\n\n```bash\ncheck_env() {\n  local missing=0\n\n  # Auto-detect repository context\n  auto_detect_repo || missing=1\n  auto_detect_branch\n\n  # Required vars (REPO_URL may have been auto-detected)\n  for var in GITHUB_TOKEN REPO_URL; do\n    if [ -z \"\\${!var}\" ]; then\n      error \"Missing required environment variable: \\$var\"\n      missing=1\n    fi\n  done\n  # ... rest of check_env\n}\n```\n\n#### 3. Database Name Configuration (docker-compose.yml)\n\nCurrent (line 15, 41):\n```yaml\nPOSTGRES_DB: hriste_development\nDATABASE_URL: postgis://claude:claude@postgres:5432/hriste_development\n```\n\nNew:\n```yaml\nPOSTGRES_DB: \\${DATABASE_NAME:-sandbox_development}\nDATABASE_URL: postgis://claude:claude@postgres:5432/\\${DATABASE_NAME:-sandbox_development}\n```\n\n#### 4. Documentation Updates (README.md)\n\nAdd new section after \"Quick Start\":\n\n```markdown\n## Global Installation\n\nTo use claude-sandbox from any directory:\n\n### Option 1: Add to PATH\n\n\\`\\`\\`bash\n# Add to ~/.bashrc or ~/.zshrc\nexport PATH=\\\"\\$HOME/.claude/claude-sandbox/bin:\\$PATH\\\"\n\\`\\`\\`\n\n### Option 2: Symlink to Local Bin\n\n\\`\\`\\`bash\nln -s ~/.claude/claude-sandbox/bin/claude-sandbox ~/.local/bin/claude-sandbox\n# Ensure ~/.local/bin is in PATH\n\\`\\`\\`\n\n### Auto-Detection\n\nWhen called from within a git repository, claude-sandbox will automatically detect:\n- REPO_URL: From git remote get-url origin\n- REPO_BRANCH: From git branch --show-current\n\nThese can still be overridden with environment variables.\n\nExample:\n\\`\\`\\`bash\ncd ~/projects/my-app\n# No need to set REPO_URL or REPO_BRANCH\nclaude-sandbox local \"fix the login bug\"\n\\`\\`\\`\n\nOverride auto-detection:\n\\`\\`\\`bash\nREPO_URL=\"https://github.com/other/repo.git\" \\\\\nREPO_BRANCH=\"develop\" \\\\\nclaude-sandbox local \"work on feature X\"\n\\`\\`\\`\n```\n\nUpdate environment variables table to show auto-detection:\n\n```markdown\n| Variable | Default | Description |\n|----------|---------|-------------|\n| REPO_URL | Auto-detected from git | Repository URL (auto-detected from git remote get-url origin) |\n| REPO_BRANCH | Auto-detected or main | Branch to clone (auto-detected from git branch --show-current) |\n| DATABASE_NAME | sandbox_development | PostgreSQL database name |\n```\n\n#### 5. .gitignore Pattern\n\nAdd to /Users/tomas/.claude/claude-sandbox/.gitignore:\n\n```gitignore\n# Local environment overrides\n.env\n.env.local\n```\n\n### Watch Out For\n\n- Backward Compatibility: The script must continue to work when called as bin/claude-sandbox from the project directory. The path resolution tries the backward-compatible path FIRST before falling back to global installation.\n\n- PATH Inheritance: When using cd \\$SANDBOX_DIR (line 109, 173), ensure we're switching to the sandbox installation directory, not the caller's working directory. This is critical for docker compose to find docker-compose.yml.\n\n- Git Command Context: When auto-detecting from current directory, use git -C \\\"\\$PWD\\\" to explicitly specify the working directory, not the sandbox installation directory.\n\n- Environment Variable Precedence: Auto-detection should be a fallback only. Explicitly set env vars (from .env, direnv, or manual export) should always take precedence over auto-detection.\n\n- Database Volume Isolation: Different projects might want different database instances. The configurable DATABASE_NAME allows this, but volumes are named based on the compose file location. Consider documenting that different database names share the same postgres volume (data is isolated by database name, not volume).\n\n### Dependencies to Be Careful With\n\n- docker-compose.yml location: The cd \\$SANDBOX_DIR commands throughout the script depend on finding this file. The new path resolution MUST validate this file exists before proceeding.\n\n- Git availability: Auto-detection requires git command. Should fail gracefully if git is not installed or current directory isn't a git repo.\n\n- envsubst for k8s (line 164): This already reads from environment, so auto-detected values will work correctly.\n\n- Build script path copying (line 176-193): Uses \\$HOME/.claude/agents as source - this is independent of caller's directory, so no changes needed.\n\n### Testing Approach\n\nManual testing checklist:\n\n1. Backward compatibility - Call from project directory:\n   cd ~/.claude/claude-sandbox\n   bin/claude-sandbox build\n   bin/claude-sandbox local \"test task\"\n\n2. Global with PATH:\n   export PATH=\"\\$HOME/.claude/claude-sandbox/bin:\\$PATH\"\n   cd ~/projects/some-repo\n   claude-sandbox local \"test task\"\n\n3. Global with symlink:\n   ln -sf ~/.claude/claude-sandbox/bin/claude-sandbox ~/.local/bin/\n   cd ~/projects/some-repo\n   claude-sandbox local \"test task\"\n\n4. Auto-detection override:\n   cd ~/projects/repo-a\n   REPO_URL=\"https://github.com/user/repo-b.git\" claude-sandbox local \"test\"\n   # Should use repo-b, not repo-a\n\n5. Error cases:\n   - Call from non-git directory (no origin)\n   - Call with missing GITHUB_TOKEN\n   - Call with missing docker-compose.yml\n   - Call from directory without git installed\n\n6. Database name configuration:\n   DATABASE_NAME=\"my_project_dev\" claude-sandbox local \"test\"\n   # Verify postgres created \"my_project_dev\" database\n\n### Edge Cases\n\n- Detached HEAD state: git branch --show-current returns empty. Script should fall back to default main (already handled by entrypoint.sh default).\n\n- Multiple remotes: Script uses origin specifically. If a repo has multiple remotes but no origin, auto-detection fails (acceptable - user can set REPO_URL manually).\n\n- SSH vs HTTPS URLs: Git remote can return git@github.com:user/repo.git or https://github.com/user/repo.git. Entrypoint.sh (line 54) already handles HTTPS conversion for authentication, so we can accept both formats.\n\n- Relative paths: If someone sets SANDBOX_DIR manually, ensure all paths are absolute by using \\$(cd ... \u0026\u0026 pwd) pattern.\n\n### Success Criteria\n\nAfter implementation:\n1. Can run claude-sandbox from any directory when in PATH\n2. Auto-detects REPO_URL from git remote origin\n3. Auto-detects REPO_BRANCH from current branch\n4. Database name is configurable via DATABASE_NAME env var\n5. Still works when called as bin/claude-sandbox from installation directory\n6. Explicitly set env vars override auto-detection\n7. Clear error messages when auto-detection fails\n8. Documentation reflects global usage patterns","created_at":"2026-01-31T10:32:56Z"},{"id":5,"issue_id":".claude-8bp","author":"Tomáš Landovský","text":"## Implementation Complete\n\nSuccessfully transformed claude-sandbox into a globally callable command with auto-detection. All planned changes have been implemented and tested.\n\n### Changes Made\n\n1. **Path Resolution (bin/claude-sandbox)**: Added backward-compatible path resolution that checks for docker-compose.yml in two locations:\n   - Script's parent directory (backward compatible)\n   - ~/.claude/claude-sandbox (global installation)\n   \n2. **Auto-Detection Functions (bin/claude-sandbox)**: Added two new functions:\n   - `auto_detect_repo()`: Auto-detects REPO_URL from `git remote get-url origin`\n   - `auto_detect_branch()`: Auto-detects REPO_BRANCH from `git branch --show-current`\n   - Both functions respect explicitly set environment variables and only detect when not set\n   \n3. **Modified check_env()**: Updated to call auto-detection functions before validating required variables\n\n4. **Database Configuration (docker-compose.yml)**: Made database name configurable via DATABASE_NAME environment variable with default value of \"sandbox_development\"\n\n5. **Documentation (README.md)**: Added comprehensive global installation section with:\n   - Two installation options (PATH and symlink)\n   - Auto-detection explanation and examples\n   - Updated environment variables table showing auto-detection\n\n6. **Git Ignore (.gitignore)**: Added .env and .env.local patterns for local configuration\n\n### Testing Results\n\nAll tests passed:\n\n- **Backward compatibility**: ✓ Works when called as `bin/claude-sandbox` from installation directory\n- **Auto-detection**: ✓ Successfully detects REPO_URL and REPO_BRANCH from current git repository\n- **Error handling**: ✓ Clear error messages when not in a git repo or missing origin remote\n- **Override**: ✓ Explicit env vars properly override auto-detection\n- **Path resolution**: ✓ Finds docker-compose.yml correctly in both scenarios\n\n### Commits\n\n1. `feat: add global path resolution to claude-sandbox script`\n2. `feat: make database name configurable via environment variable`\n3. `chore: add .env patterns to .gitignore`\n4. `docs: add global installation and auto-detection documentation`\n\n### Notes\n\n- All changes maintain backward compatibility\n- Auto-detection only activates when env vars are not explicitly set\n- Clear error messages guide users when auto-detection fails\n- The implementation follows all patterns and warnings from the plan","created_at":"2026-01-31T10:42:03Z"}]}
{"id":".claude-9ba","title":"Add database readiness check to entrypoint.sh","description":"entrypoint.sh runs Rails db commands immediately without waiting for Postgres sidecar to be ready. In k8s, there's no depends_on health checks like docker-compose. Solution: Add pg_isready wait loop before database operations.","status":"open","priority":2,"issue_type":"bug","owner":"landovsky@gmail.com","created_at":"2026-01-31T17:47:56.971911+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:47:56.971911+01:00"}
{"id":".claude-9nr","title":"Fix inter-stage data passing in development workflow","description":"Passing data between workflow stages via files consistently fails. Redesign the inter-stage communication mechanism. User proposes using bd task comments/descriptions to store stage outputs. Need analysis of alternatives.","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T02:05:13.486643+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:18:40.731576+01:00","closed_at":"2026-01-28T10:18:40.731576+01:00","close_reason":"All 4 stages complete. File-based handoffs replaced with bd comments. Critical fix: added Bash tool to analyst and planner toolsets."}
{"id":".claude-9nr.1","title":"Analyze inter-stage communication problem and propose solutions","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T02:05:17.372129+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T02:18:15.479804+01:00","closed_at":"2026-01-28T02:18:15.479804+01:00","close_reason":"Analysis complete. Root cause: planner lacks Write tool; file-based handoff is structurally broken. Recommended: master-as-relay using Task tool return values.","dependencies":[{"issue_id":".claude-9nr.1","depends_on_id":".claude-9nr","type":"parent-child","created_at":"2026-01-28T02:05:17.372734+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-9nr.2","title":"Plan implementation of chosen approach","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T02:05:17.451445+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:03:35.521167+01:00","closed_at":"2026-01-28T10:03:35.521167+01:00","close_reason":"Plan complete. Approach A: bd comments as inter-stage transport. Planner needs Bash tool added. Master needs ID-passing logic.","dependencies":[{"issue_id":".claude-9nr.2","depends_on_id":".claude-9nr","type":"parent-child","created_at":"2026-01-28T02:05:17.452022+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-9nr.2","depends_on_id":".claude-9nr.1","type":"blocks","created_at":"2026-01-28T02:05:34.568294+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-9nr.3","title":"Implement inter-stage communication redesign","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T02:05:17.52185+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:16:12.047063+01:00","closed_at":"2026-01-28T10:16:12.047063+01:00","close_reason":"Closed","dependencies":[{"issue_id":".claude-9nr.3","depends_on_id":".claude-9nr","type":"parent-child","created_at":"2026-01-28T02:05:17.522422+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-9nr.3","depends_on_id":".claude-9nr.2","type":"blocks","created_at":"2026-01-28T02:05:34.625262+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-9nr.4","title":"Review implementation","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T02:05:17.591167+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:18:24.090055+01:00","closed_at":"2026-01-28T10:18:24.090055+01:00","close_reason":"Closed","dependencies":[{"issue_id":".claude-9nr.4","depends_on_id":".claude-9nr","type":"parent-child","created_at":"2026-01-28T02:05:17.591764+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-9nr.4","depends_on_id":".claude-9nr.3","type":"blocks","created_at":"2026-01-28T02:05:34.679631+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-9vi","title":"Remove broken init container pattern from k8s job template","description":"Init container tries to background Postgres then exits, killing the backgrounded process. Creates race condition where main container starts before sidecars are ready. Solution: Remove init container entirely, rely on sidecars only.","status":"closed","priority":2,"issue_type":"bug","owner":"landovsky@gmail.com","created_at":"2026-01-31T17:47:51.082913+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:50:32.512162+01:00","closed_at":"2026-01-31T17:50:32.512162+01:00","close_reason":"Removed broken init container pattern from k8s/job-template.yaml. The init container attempted to background Postgres then exit, which killed the backgrounded process. Now relying solely on postgres-sidecar which runs properly alongside the main container."}
{"id":".claude-b2m","title":"Fix inter-agent data flow: bd comments, Input sections, variable naming","description":"6 specific fixes across agent files: 1) bd show→bd comments for reading upstream output, 2) Standardize Input sections for bd-primary, 3) Add invocation syntax to master.md, 4) Standardize [task-id] naming, 5) Fix reviewer Phase 1 formatting, 6) Clarify output validation","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T21:11:48.674675+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T21:13:03.138353+01:00","closed_at":"2026-01-28T21:13:03.138353+01:00","close_reason":"Duplicate of .claude-2uo"}
{"id":".claude-eb4","title":"Claude in sandbox doesn't resolve beads task IDs","description":"When running 'claude-sandbox local \"/develop .claude-muf\"', the sandboxed Claude Code session fails to recognize that '.claude-muf' refers to a beads task. Instead of looking up the task with 'bd show .claude-muf', Claude treats it as a file path and looks for a literal file named '.claude-muf' in the workspace.","status":"closed","priority":2,"issue_type":"bug","owner":"landovsky@gmail.com","created_at":"2026-01-31T13:29:59.070892+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T15:38:37.796776+01:00","closed_at":"2026-01-31T15:38:37.796776+01:00","close_reason":"Closed","comments":[{"id":6,"issue_id":".claude-eb4","author":"Tomáš Landovský","text":"# Debug Analysis: Claude in sandbox doesn't resolve beads task ID `.claude-muf`\n\n## Problem Summary\n\nWhen running `claude-sandbox local \"/develop .claude-muf\"`, the sandboxed Claude Code session receives the task string `print task description .claude-muf` (or `/develop .claude-muf`) but fails to recognize that `.claude-muf` refers to a beads task. Instead of looking up the task with `bd show .claude-muf`, Claude treats it as a file path and looks for a literal file named `.claude-muf` in the workspace.\n\n**Symptom**: Claude says \"The file `.claude-muf` doesn't exist in the workspace\" and searches for files with similar names.\n\n**Expected**: Claude should recognize `.claude-muf` as a beads task ID and run `bd show .claude-muf` or `bd comments .claude-muf` to retrieve the task.\n\n**Verified**: The task `.claude-muf` exists in `.beads/issues.jsonl` with title \"Move lessons-learned.md to artifacts directory\".\n\n## Missing Information\n\n- What exact prompt does Claude receive inside the container? (Need to verify the TASK variable reaches Claude correctly)\n- Does the sandbox have `bd` available in PATH?\n- Does the sandbox have the `.beads/` directory with the issues.jsonl file?\n- What instructions does the `/develop` command give Claude about task ID resolution?\n\n## Hypotheses\n\n### Hypothesis 1: The `.beads/` directory is not cloned into the sandbox workspace\n\n**Likelihood:** High\n\n**Theory:** The sandbox clones the repository fresh from the remote. If `.beads/` or `.beads/issues.jsonl` is gitignored or not pushed to the remote, the sandboxed Claude won't have access to the task database, so `bd` commands won't find any tasks.\n\n**Supporting evidence:**\n- The `.beads/` directory typically contains local database state\n- `.beads/config.yaml` and `.beads/issues.jsonl` may be gitignored in some setups\n- The sandbox log shows \"HEAD is now at 1e37439\" suggesting a clean checkout\n- Claude's response shows it searched for files but found none matching `.claude-muf`\n\n**Contradicting evidence:**\n- User says they \"verified that bd list contains this task in container's workspace/ directory\" (but this verification method is unclear)\n\n**How to test:**\n1. Check if `.beads/` is in the remote repository:\n   ```bash\n   git ls-tree -r HEAD --name-only | grep -E \"^\\.beads/\"\n   ```\n2. SSH into the running container or check the workspace volume:\n   ```bash\n   docker exec -it \u003ccontainer\u003e ls -la /workspace/.beads/\n   docker exec -it \u003ccontainer\u003e bd list\n   ```\n3. Check the repo's `.gitignore` for `.beads/` patterns\n\n**If confirmed, offer to:**\n- Fix the `.gitignore` to include `.beads/issues.jsonl`\n- Or create a sync mechanism to copy `.beads/` into the sandbox\n\n---\n\n### Hypothesis 2: The `/develop` command doesn't instruct Claude how to interpret task IDs\n\n**Likelihood:** High\n\n**Theory:** The `/develop` command in `commands/develop.md` documents `bd` commands but doesn't explicitly tell Claude that arguments starting with `.claude-` are task IDs that should be looked up with `bd show`. Claude sees the literal string `.claude-muf` and interprets it as a file path because nothing tells it otherwise.\n\n**Supporting evidence:**\n- Looking at `develop.md`, the `$ARGUMENTS` placeholder passes the raw argument but there's no instruction saying \"if ARGUMENTS starts with `.claude-`, treat it as a task ID\"\n- The Phase 1 \"Assess the Request\" section doesn't mention parsing task IDs from the input\n- Claude's behavior (looking for a file) matches what happens when it receives an unfamiliar token without context\n\n**Contradicting evidence:**\n- The develop.md extensively documents `bd` commands, so Claude might infer task ID syntax\n- `.claude-xxx` prefix is distinctive and could be recognized as a beads ID\n\n**How to test:**\n1. Check if `develop.md` has any instruction for task ID parsing:\n   ```bash\n   grep -i \"task.*id\\|\\.claude-\\|argument\\|parse\" commands/develop.md\n   ```\n2. Test locally with a verbose run to see what prompt Claude receives\n3. Add explicit instruction to `develop.md` and see if behavior changes\n\n**If confirmed, offer to:**\n- Add a section to `develop.md` explaining how to parse task ID arguments\n- Example: \"If ARGUMENTS matches `.claude-XXX` pattern, retrieve the task with `bd show [id]`\"\n\n---\n\n### Hypothesis 3: `bd` CLI is not installed or not in PATH inside the sandbox container\n\n**Likelihood:** Medium\n\n**Theory:** The sandbox container builds from a Dockerfile that may not include the `bd` binary. Even if the `.beads/` directory exists, Claude can't query it without the `bd` CLI tool.\n\n**Supporting evidence:**\n- The Dockerfile and entrypoint.sh don't show `bd` installation\n- `bd` is a relatively new tool that wouldn't be in standard base images\n\n**Contradicting evidence:**\n- The `/develop` command references `bd` commands extensively, suggesting it should be available\n- User claims they verified `bd list` works in the container\n\n**How to test:**\n1. Check if `bd` is available in the container:\n   ```bash\n   docker exec -it \u003ccontainer\u003e which bd\n   docker exec -it \u003ccontainer\u003e bd --version\n   ```\n2. Check the Dockerfile for `bd` installation steps\n3. Try running `bd list` inside a fresh container\n\n**If confirmed, offer to:**\n- Add `bd` installation to the Dockerfile\n- Create a task using /bd-task\n\n---\n\n### Hypothesis 4: The task argument is being passed but Claude doesn't trigger the `/develop` skill\n\n**Likelihood:** Medium\n\n**Theory:** When the task is `\"/develop .claude-muf\"`, Claude may not recognize this as invoking the `/develop` skill/command. The entrypoint passes `$TASK` directly to `claude -p \"$TASK\"`, and if Claude doesn't interpret leading `/develop` as a skill invocation, it treats the whole string as a natural language request.\n\n**Supporting evidence:**\n- The sandbox output says `[sandbox] Task: print task description .claude-muf` for the test run, which is different from `/develop .claude-muf`\n- Claude's response was to look for a file, not to run the develop workflow\n- The skill invocation mechanism may require specific formatting or context\n\n**Contradicting evidence:**\n- The example uses `\"/develop .claude-muf\"` which should trigger the skill\n- Skill tool documentation says `/\u003cskill-name\u003e` should invoke skills\n\n**How to test:**\n1. Run the sandbox with explicit `/develop` prefix and check Claude's interpretation:\n   ```bash\n   claude-sandbox local \"/develop .claude-muf\"\n   ```\n2. Check Claude's first action - does it invoke the develop skill or treat it as text?\n3. Try running without the slash: `claude-sandbox local \"develop .claude-muf\"`\n\n**If confirmed, offer to:**\n- Investigate how skills are invoked in non-interactive `-p` mode\n- Update entrypoint or task passing mechanism\n\n---\n\n### Hypothesis 5: The beads task database path differs between host and container\n\n**Likelihood:** Low\n\n**Theory:** `bd` may be looking for tasks in a different location than where `.beads/issues.jsonl` exists. The database path could be configured differently inside the container vs the host.\n\n**Supporting evidence:**\n- `bd` can use SQLite database or JSONL file based on config\n- Container environment may have different `BEADS_DB` or working directory\n\n**Contradicting evidence:**\n- `bd` auto-discovers `.beads/` in the current directory by default\n- User verified `bd list` works in container\n\n**How to test:**\n1. Inside the container, check `bd` configuration:\n   ```bash\n   docker exec -it \u003ccontainer\u003e bd config\n   docker exec -it \u003ccontainer\u003e pwd\n   docker exec -it \u003ccontainer\u003e ls -la .beads/\n   ```\n\n**If confirmed, offer to:**\n- Set explicit `BEADS_DB` environment variable in docker-compose.yml\n\n## Recommended Investigation Order\n\n1. **Hypothesis 1 (High)**: Check if `.beads/issues.jsonl` is in the remote repo and cloned into the workspace. This is most likely the root cause since sandboxes start fresh from git.\n\n2. **Hypothesis 2 (High)**: Review `develop.md` for task ID parsing instructions. Even if `.beads/` exists, Claude needs to know to use `bd show` on task IDs.\n\n3. **Hypothesis 4 (Medium)**: Verify that `/develop` skill is being invoked properly in `-p` mode. The test output shows a different task string which suggests skill invocation may not be happening.\n\n4. **Hypothesis 3 (Medium)**: Confirm `bd` is installed in the container. Quick check.\n\n5. **Hypothesis 5 (Low)**: Only if others are ruled out.\n\n## Quick Wins\n\n1. **Verify .beads/ in git**:\n   ```bash\n   git ls-tree -r HEAD --name-only | grep beads\n   cat .gitignore | grep beads\n   ```\n\n2. **Add explicit task ID instruction to develop.md**:\n   Add after `$ARGUMENTS`:\n   ```markdown\n   If the argument matches pattern `.claude-XXX`, it's a beads task ID. Retrieve it with:\n   ```bash\n   bd show [task-id]\n   ```\n   ```\n\n3. **Test bd availability in container**:\n   ```bash\n   docker run --rm claude-sandbox:latest which bd\n   ```\n\n## Need More Info?\n\nIf the hypotheses don't pan out:\n\n1. Add verbose logging to entrypoint.sh to see exact prompt passed to Claude\n2. Enable Claude's `--verbose` output and capture full reasoning\n3. Check if there's a difference between local Claude Code and sandboxed behavior for the same task\n4. Review the skill invocation mechanism for `-p` (prompt) mode vs interactive mode","created_at":"2026-01-31T12:30:14Z"},{"id":7,"issue_id":".claude-eb4","author":"Tomáš Landovský","text":"beads was not initialized and claude probably did not have access to the task","created_at":"2026-01-31T14:38:28Z"}]}
{"id":".claude-gvl","title":"Track severity counts and category classification over time","description":"Track counts of severities in reviews over time. Also do basic classification of the problem matter (testing, ui, ...). Desired output - track number of issues in each triage category over time. Use json. Save in directory that does not invoke Claude permission request each session.","status":"open","priority":2,"issue_type":"feature","owner":"landovsky@gmail.com","created_at":"2026-01-29T10:48:22.822938+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-29T10:48:22.822938+01:00"}
{"id":".claude-gvl.1","title":"Analyze and specify severity tracking requirements","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-30T17:19:28.767148+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-30T17:47:03.801102+01:00","closed_at":"2026-01-30T17:47:03.801102+01:00","close_reason":"Closed","dependencies":[{"issue_id":".claude-gvl.1","depends_on_id":".claude-gvl","type":"parent-child","created_at":"2026-01-30T17:19:28.767911+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":8,"issue_id":".claude-gvl.1","author":"Tomáš Landovský","text":"# Spec: Severity Tracking System\n\n## Summary\nAdd tracking of review issue counts by severity level and problem category. Each review creates a JSON datapoint stored as a bd comment on a dedicated tracking task. Supports concurrent writes and dynamic category addition.\n\n## Requirements\n- [ ] Create a dedicated bd task for storing tracking data (e.g., `.claude-metrics` or similar)\n- [ ] Reviewer agent emits a JSON payload after each review\n- [ ] Payload includes timestamp, task ID, severity counts, and category breakdown\n- [ ] Support these severity levels: Critical, Major, Minor\n- [ ] Support these base categories: Testing, UI/UX, Business Logic, Security, Performance, Code Quality, Documentation, Hints, Configuration\n- [ ] Allow reviewer to add new categories dynamically when an issue doesn't fit existing ones\n- [ ] Each tracking entry is a separate bd comment (append-only, concurrent-safe)\n- [ ] Zero-issue reviews still emit a datapoint (with all counts at 0)\n\n## Data Schema\n\nEach review emits one JSON payload as a bd comment:\n\n```json\n{\n  \"v\": 1,\n  \"ts\": \"2026-01-30T17:30:00Z\",\n  \"task\": \".claude-abc.4\",\n  \"parent\": \".claude-abc\",\n  \"severity\": {\n    \"critical\": 0,\n    \"major\": 2,\n    \"minor\": 3\n  },\n  \"categories\": {\n    \"testing\": 1,\n    \"business_logic\": 2,\n    \"code_quality\": 2\n  },\n  \"issues\": [\n    {\n      \"severity\": \"major\",\n      \"category\": \"testing\",\n      \"file\": \"src/auth.ts\",\n      \"line\": 42,\n      \"summary\": \"Missing error case test\"\n    }\n  ]\n}\n```\n\n### Field definitions:\n- `v`: Schema version (integer, start at 1)\n- `ts`: ISO 8601 timestamp when review completed\n- `task`: The reviewer subtask ID (e.g., `.claude-abc.4`)\n- `parent`: The parent task being reviewed\n- `severity`: Counts per severity level (all three keys always present)\n- `categories`: Counts per category (only categories with issues \u003e 0 included)\n- `issues`: Array of individual issues (optional, for detailed analysis)\n\n### Category keys (snake_case):\n- `testing` - Missing/inadequate tests\n- `ui_ux` - Frontend/interface issues\n- `business_logic` - Incorrect behavior\n- `security` - Vulnerabilities\n- `performance` - Efficiency issues\n- `code_quality` - Structure, naming, patterns\n- `documentation` - Missing/incorrect docs\n- `hints` - Missing hints/guidance\n- `configuration` - Config issues\n- `[new_category]` - Reviewer may add as needed\n\n## Storage mechanism\n\n### Dedicated tracking task\n1. Create task once: `bd create \"Review metrics tracking\" --id .claude-metrics`\n2. Task remains open indefinitely as a data store\n3. Each review appends: `bd comments add .claude-metrics \"[JSON payload]\"`\n\n### Concurrent write safety\n- bd comments are append-only\n- Each reviewer writes its own comment with its own timestamp\n- No read-modify-write cycle, so no race conditions\n- Git merges handle concurrent pushes naturally\n\n### Data retrieval\nConsuming tool reads all comments:\n```bash\nbd comments .claude-metrics\n```\nThen parses each comment as JSON, aggregates as needed.\n\n## Edge cases\n- [ ] Review finds zero issues: Emit payload with all severity counts = 0, empty categories object, empty issues array\n- [ ] Issue doesn't fit existing category: Reviewer adds new category key (snake_case), documents in issues[].summary why new category was needed\n- [ ] Malformed JSON: Consuming tool skips invalid entries, logs warning\n- [ ] Very long review (many issues): Keep issues array, schema handles arbitrary length\n\n## Acceptance criteria\n- [ ] Dedicated `.claude-metrics` task exists and persists across sessions\n- [ ] Reviewer agent emits valid JSON payload after every review\n- [ ] Payload conforms to schema (v, ts, task, parent, severity, categories all present)\n- [ ] Multiple concurrent reviews can write without conflicts\n- [ ] `bd comments .claude-metrics` returns parseable JSON entries\n- [ ] Zero-issue reviews produce valid datapoints\n\n## Out of scope\n- Aggregation logic (separate reporting tool handles this)\n- Visualization (separate tool)\n- Historical data migration (start fresh)\n- Category standardization enforcement (reviewer uses judgment)\n- Automatic metrics task creation (manual one-time setup is fine)\n\n## Artifacts consulted\n- `workflow-design/WORKFLOW.md`: Confirmed reviewer role, severity definitions, bd comments pattern\n\n## Artifacts to update\n- `agents/reviewer.md`: Add Phase 5.5 or modify Phase 7 to emit tracking payload\n\n## Open risks\n- bd comment size limits unknown - if hit, could truncate issues array (keep severity/category counts as minimum viable payload)\n- Long-running metrics task may accumulate thousands of comments - consuming tool should handle pagination if bd provides it","created_at":"2026-01-30T16:47:01Z"}]}
{"id":".claude-gvl.2","title":"Plan implementation of severity tracking","status":"in_progress","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-30T17:19:29.410836+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T21:14:48.957146+01:00","dependencies":[{"issue_id":".claude-gvl.2","depends_on_id":".claude-gvl","type":"parent-child","created_at":"2026-01-30T17:19:29.411529+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-gvl.2","depends_on_id":".claude-gvl.1","type":"blocks","created_at":"2026-01-30T17:19:35.86137+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":9,"issue_id":".claude-gvl.2","author":"Tomáš Landovský","text":"Test comment to verify bd comments works","created_at":"2026-01-30T16:54:07Z"}]}
{"id":".claude-gvl.3","title":"Implement severity tracking system","status":"open","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-30T17:19:30.070538+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-30T17:19:30.070538+01:00","dependencies":[{"issue_id":".claude-gvl.3","depends_on_id":".claude-gvl","type":"parent-child","created_at":"2026-01-30T17:19:30.071223+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-gvl.3","depends_on_id":".claude-gvl.2","type":"blocks","created_at":"2026-01-30T17:19:35.929614+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-gvl.4","title":"Review severity tracking implementation","status":"open","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-30T17:19:30.551333+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-30T17:19:30.551333+01:00","dependencies":[{"issue_id":".claude-gvl.4","depends_on_id":".claude-gvl","type":"parent-child","created_at":"2026-01-30T17:19:30.551977+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-gvl.4","depends_on_id":".claude-gvl.3","type":"blocks","created_at":"2026-01-30T17:19:35.997179+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-j3r","title":"Improve CLAUDE_IMAGE default in k8s template","description":"Template uses placeholder 'your-registry/claude-sandbox:latest' which will fail. Solution: Add better documentation or fail-fast validation in bin/claude-sandbox remote command.","status":"open","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-31T17:48:14.408969+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:48:14.408969+01:00"}
{"id":".claude-muf","title":"Move lessons-learned.md to artifacts directory","description":"Update workflow to read/write lessons-learned.md in artifacts/lessons-learned.md. Currently it's in .claude/ and Claude is asking to edit each session.","status":"closed","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-29T09:04:41.025876+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:26:21.174145+01:00","closed_at":"2026-01-31T16:25:19.136214875Z"}
{"id":".claude-nh6","title":"User Authentication System","status":"tombstone","priority":2,"issue_type":"epic","owner":"landovsky@gmail.com","created_at":"2026-01-29T06:43:34.109079+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-29T06:48:13.726151+01:00","deleted_at":"2026-01-29T06:48:13.726151+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"epic"}
{"id":".claude-nh6.1","title":"Create user database schema and migrations","description":"Design and implement the database schema for storing user credentials, sessions, and profile data. Include migrations for creating tables.","status":"tombstone","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-29T06:43:39.559933+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-29T06:48:13.726151+01:00","deleted_at":"2026-01-29T06:48:13.726151+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":".claude-nh6.2","title":"Implement authentication API endpoints","description":"Build REST API endpoints for login, logout, register, password reset, and session validation. Includes JWT token handling.","status":"tombstone","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-29T06:43:44.044445+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-29T06:48:13.726151+01:00","deleted_at":"2026-01-29T06:48:13.726151+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":".claude-nh6.3","title":"Build login/logout UI components","description":"Create React components for login form, registration form, password reset flow, and user session management in the frontend.","status":"tombstone","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-29T06:43:48.062248+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-29T06:48:13.726151+01:00","deleted_at":"2026-01-29T06:48:13.726151+01:00","deleted_by":"batch delete","delete_reason":"batch delete","original_type":"task"}
{"id":".claude-p6j","title":"Fix hardcoded database name in k8s template","description":"k8s job-template.yaml hardcodes 'hriste_development' while docker-compose uses configurable DATABASE_NAME. Makes system less portable. Solution: Use environment variable from secrets for database name.","status":"open","priority":2,"issue_type":"bug","owner":"landovsky@gmail.com","created_at":"2026-01-31T17:48:01.523235+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:48:01.523235+01:00"}
{"id":".claude-sto","title":"Add Redis readiness check to entrypoint.sh","description":"Similar to Postgres, Redis sidecar may not be ready when entrypoint.sh runs. Solution: Add redis-cli ping wait loop before any Redis operations.","status":"open","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-31T17:48:05.39344+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:48:05.39344+01:00"}
{"id":".claude-v77","title":"Mock: Add greeting message to CLI","description":"Add a --greet flag to the CLI that prints 'Hello, world\\!'","status":"closed","priority":3,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T10:19:48.728021+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:20:58.091752+01:00","closed_at":"2026-01-28T10:20:58.091752+01:00","close_reason":"Mock test complete. bd comments transport verified."}
{"id":".claude-v77.1","title":"Analyze greeting feature","status":"closed","priority":3,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T10:19:52.363556+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:20:13.639182+01:00","closed_at":"2026-01-28T10:20:13.639182+01:00","close_reason":"Closed","dependencies":[{"issue_id":".claude-v77.1","depends_on_id":".claude-v77","type":"parent-child","created_at":"2026-01-28T10:19:52.36426+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":10,"issue_id":".claude-v77.1","author":"Tomáš Landovský","text":"# Spec: Add greeting message to CLI\n\n## Summary\nAdd a --greet flag that prints \"Hello, world!\" and exits.\n\n## Requirements\n- [ ] CLI accepts --greet flag\n- [ ] Prints \"Hello, world!\" to stdout\n- [ ] Exits with code 0\n\n## Edge cases\n- [ ] --greet combined with other flags: ignore other flags, just greet\n\n## Acceptance criteria\n- [ ] Running `cli --greet` outputs exactly \"Hello, world!\"","created_at":"2026-01-28T09:20:13Z"}]}
{"id":".claude-v77.2","title":"Plan greeting feature","status":"closed","priority":3,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T10:19:52.441895+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:20:29.971767+01:00","closed_at":"2026-01-28T10:20:29.971767+01:00","close_reason":"Closed","dependencies":[{"issue_id":".claude-v77.2","depends_on_id":".claude-v77","type":"parent-child","created_at":"2026-01-28T10:19:52.442558+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-v77.2","depends_on_id":".claude-v77.1","type":"blocks","created_at":"2026-01-28T10:19:56.22763+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":11,"issue_id":".claude-v77.2","author":"Tomáš Landovský","text":"# Plan: Add greeting message to CLI\n\n## Branch\n`feature/.claude-v77-greeting`\n\n## Overview\nSimple flag addition. Add --greet to argument parser, print message, exit.\n\n## Files to change\n- [ ] src/cli.js - Add --greet to arg parser, handle in main()\n\n## Key pattern\nFollow existing --help flag pattern in src/cli.js:14\n\n## Watch out for\n- Ensure greeting goes to stdout (not stderr)","created_at":"2026-01-28T09:20:29Z"}]}
{"id":".claude-v77.3","title":"Implement greeting feature","status":"closed","priority":3,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T10:19:52.515919+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:20:43.889869+01:00","closed_at":"2026-01-28T10:20:43.889869+01:00","close_reason":"Closed","dependencies":[{"issue_id":".claude-v77.3","depends_on_id":".claude-v77","type":"parent-child","created_at":"2026-01-28T10:19:52.51659+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-v77.3","depends_on_id":".claude-v77.2","type":"blocks","created_at":"2026-01-28T10:19:56.298437+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":12,"issue_id":".claude-v77.3","author":"Tomáš Landovský","text":"# Implementation Notes\n- Added --greet flag following --help pattern\n- Prints to stdout, exits 0\n- Tests added for --greet flag and combination with other flags","created_at":"2026-01-28T09:20:43Z"}]}
{"id":".claude-v77.4","title":"Review greeting feature","status":"closed","priority":3,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-28T10:19:52.587645+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-28T10:20:58.018743+01:00","closed_at":"2026-01-28T10:20:58.018743+01:00","close_reason":"Closed","dependencies":[{"issue_id":".claude-v77.4","depends_on_id":".claude-v77","type":"parent-child","created_at":"2026-01-28T10:19:52.58825+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-v77.4","depends_on_id":".claude-v77.3","type":"blocks","created_at":"2026-01-28T10:19:56.369488+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":13,"issue_id":".claude-v77.4","author":"Tomáš Landovský","text":"Review: LGTM. All requirements met.","created_at":"2026-01-28T09:20:57Z"}]}
{"id":".claude-vob","title":"Improve log management for parallel k8s deployments","description":"When running multiple claude-sandbox jobs in parallel, it's hard to track which logs belong to which job.\n\nCurrent: bin/claude-sandbox logs shows most recent job only\n\nImprovement: Add labels to job template for better filtering:\n- repo: extracted from REPO_URL\n- branch: from REPO_BRANCH\n- task-type: optional classification\n\nThen update bin/claude-sandbox logs to:\n- List all running jobs with labels\n- Allow filtering: bin/claude-sandbox logs --repo=hriste --branch=main\n- Show job metadata in output\n\nFiles to modify:\n- bin/claude-sandbox (cmd_remote to add labels, cmd_logs to support filtering)\n- k8s/job-template.yaml (add label fields)\n\nRelated to parallel deployments support.","status":"open","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-31T20:25:09.841058+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T20:25:09.841058+01:00"}
{"id":".claude-yad","title":"Implement multi-Ruby version support via image tagging","description":"Support multiple Ruby versions through tagged Docker images instead of static build-time version. Auto-detect from .ruby-version and select appropriate image.","status":"open","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-01T05:38:56.405401+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-01T05:38:56.405401+01:00"}
{"id":".claude-yad.1","title":"Plan multi-Ruby implementation","status":"closed","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-01T05:39:03.429373+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-01T05:41:41.20827+01:00","closed_at":"2026-02-01T05:41:41.208273+01:00","dependencies":[{"issue_id":".claude-yad.1","depends_on_id":".claude-yad","type":"parent-child","created_at":"2026-02-01T05:39:03.430127+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-yad.1","depends_on_id":".claude-yad.2","type":"blocks","created_at":"2026-02-01T05:39:06.47337+01:00","created_by":"Tomáš Landovský"}],"comments":[{"id":16,"issue_id":".claude-yad.1","author":"Tomáš Landovský","text":"# Plan: Multi-Ruby Version Support via Image Tagging\n\n## Branch\n`feature/.claude-yad-multi-ruby-version-support`\n\n## Overview\nCurrently, the sandbox supports a single Ruby version (3.4.7) hardcoded in the Dockerfile. This plan adds support for building multiple Ruby version images with tags (e.g., ruby-3.2, ruby-3.3, ruby-3.4), automatic version detection from .ruby-version files, and seamless image selection. The approach uses a config file to centralize version management and updates all orchestration layers (build script, docker-compose, k8s, launcher).\n\n## Key patterns to follow\n- `/Users/tomas/.claude/claude-sandbox/bin/claude-sandbox` (lines 241-290) - Build command structure, shows how to read config and build images\n- `/Users/tomas/.claude/claude-sandbox/entrypoint.sh` (lines 137-164) - Project detection pattern, shows how to detect project features\n- `/Users/tomas/.claude/claude-sandbox/Dockerfile` (lines 6-7) - Build args pattern for version control\n- `/Users/tomas/.claude/claude-sandbox/docs/ENV-FILES.md` - Documentation pattern for configuration files\n\n## Files to change\n- [ ] `/Users/tomas/.claude/claude-sandbox/ruby-versions.yaml` - NEW: Config file listing supported Ruby versions\n- [ ] `/Users/tomas/.claude/claude-sandbox/bin/claude-sandbox` - Update build command to read config and build multiple tagged images\n- [ ] `/Users/tomas/.claude/claude-sandbox/bin/claude-sandbox` - Update local/remote commands to detect .ruby-version and select image tag\n- [ ] `/Users/tomas/.claude/claude-sandbox/docker-compose.yml` - Add support for image tag override via environment variable\n- [ ] `/Users/tomas/.claude/claude-sandbox/k8s/job-template.yaml` - Update to use image tag variable\n- [ ] `/Users/tomas/.claude/claude-sandbox/README.md` - Update with multi-version approach, remove \"Change Ruby Version\" section (lines 315-323)\n- [ ] `/Users/tomas/.claude/claude-sandbox/docs/RUBY-VERSIONS.md` - NEW: Document Ruby version management\n\n## Watch out for\n- **Image tag compatibility**: Docker image tags must be valid (lowercase, alphanumeric, dashes, underscores, periods). Using format `ruby-X.Y` (e.g., `ruby-3.2`) is safe and readable.\n- **Default version selection**: When no .ruby-version file exists, need a sensible default. Use the highest version from config (3.4) to maintain backward compatibility.\n- **Version parsing from .ruby-version**: Files can contain patch versions (3.3.1) but we need major.minor (3.3). Extract first two segments only.\n- **.ruby-version file location**: The file is in the project repository, which doesn't exist until entrypoint.sh clones it. Detection must happen in the launcher (bin/claude-sandbox) BEFORE starting the container, not in entrypoint.sh. This means the launcher needs to do a shallow clone or git archive to read .ruby-version.\n- **Backward compatibility**: Existing workflows expect `claude-sandbox:latest`. Keep building a latest tag that points to the newest Ruby version (3.4).\n- **Build time**: Building 3 Ruby versions will triple build time. Each ruby-install takes 5-10 minutes. Consider documenting that users can build only the versions they need by editing the config.\n- **Registry tagging**: When pushing to registry (cmd_push), need to push all version tags, not just latest.\n- **K8s image pull**: Kubernetes needs specific image tags. The job template uses ${CLAUDE_IMAGE}, which works, but ensure the tag is appended correctly.\n\n## Dependencies to be careful with\n- `/Users/tomas/.claude/claude-sandbox/Dockerfile` - RUBY_VERSION build arg is consumed by ruby-install on line 64. Ensure this stays compatible.\n- `/Users/tomas/.claude/claude-sandbox/docker-compose.yml` - Currently uses `image: claude-sandbox:latest`. When switching to tagged images, docker-compose run must specify the tag.\n- `bin/claude-sandbox` cmd_local (lines 176-182) - Checks for image existence with grep. Need to update to check for the specific tag, not just :latest.\n- `bin/claude-sandbox` cmd_build - Currently builds single image. Will loop over versions from config.\n- `bin/claude-sandbox` auto_detect_repo (lines 54-80) - Pattern for auto-detection. Similar logic needed for .ruby-version detection.\n\n## Testing approach\n- Unit (manual verification):\n  - Create ruby-versions.yaml with 3 versions (3.2.6, 3.3.6, 3.4.7)\n  - Run build, verify 4 images created: ruby-3.2, ruby-3.3, ruby-3.4, latest\n  - Verify each image has correct Ruby version: `docker run claude-sandbox:ruby-3.2 ruby -v`\n- Integration:\n  - Create test project with .ruby-version containing \"3.3.1\"\n  - Run `bin/claude-sandbox local \"ruby -v\"`, verify it uses ruby-3.3 image\n  - Create test project with no .ruby-version, verify it uses latest (3.4)\n  - Test docker-compose with IMAGE_TAG override: `IMAGE_TAG=ruby-3.2 docker compose run claude`\n  - Test k8s template with CLAUDE_IMAGE including tag\n- Edge cases from spec:\n  - .ruby-version with patch: \"3.3.1\" → extract \"3.3\"\n  - .ruby-version with only major.minor: \"3.4\" → use as-is\n  - .ruby-version missing → use latest/default (3.4)\n  - .ruby-version with unsupported version: \"3.1.0\" → error with helpful message\n  - Project in subdirectory - .ruby-version detection may need to walk up tree\n\n## Documentation to update\n- [ ] `/Users/tomas/.claude/claude-sandbox/README.md` - Replace \"Change Ruby Version\" section with \"Ruby Version Management\"\n  - Remove lines 315-323 (old manual change instructions)\n  - Add new section explaining:\n    - Automatic detection from .ruby-version\n    - Supported versions (link to ruby-versions.yaml)\n    - How to build specific versions only\n    - Manual override with IMAGE_TAG env var\n- [ ] NEW: `/Users/tomas/.claude/claude-sandbox/docs/RUBY-VERSIONS.md` - Comprehensive guide:\n  - How version detection works\n  - ruby-versions.yaml format\n  - Building images for specific versions\n  - Troubleshooting version mismatches\n  - Adding new Ruby versions\n\n## Implementation sequence\n1. Create ruby-versions.yaml config file with current supported versions\n2. Update bin/claude-sandbox cmd_build to:\n   - Read ruby-versions.yaml (use yq or python/ruby for parsing)\n   - Loop over versions, build each with --build-arg RUBY_VERSION\n   - Tag each as claude-sandbox:ruby-X.Y\n   - Keep latest tag pointing to highest version\n3. Add .ruby-version auto-detection to bin/claude-sandbox:\n   - New function auto_detect_ruby_version (similar to auto_detect_repo)\n   - For local runs: check if REPO_URL is a local path first, else do shallow clone\n   - Extract major.minor from .ruby-version content\n   - Validate against ruby-versions.yaml\n   - Set IMAGE_TAG environment variable\n4. Update cmd_local to use detected IMAGE_TAG:\n   - Pass IMAGE_TAG to docker-compose\n   - Update image existence check to look for specific tag\n5. Update docker-compose.yml:\n   - Change `image: claude-sandbox:latest` to `image: claude-sandbox:${IMAGE_TAG:-latest}`\n6. Update cmd_remote to pass IMAGE_TAG:\n   - Append tag to CLAUDE_IMAGE if needed\n   - Ensure k8s job-template.yaml receives full image name with tag\n7. Update k8s/job-template.yaml if needed (likely already supports via ${CLAUDE_IMAGE})\n8. Update cmd_push to push all version tags\n9. Write documentation\n10. Update README\n\n## Lessons from past work\nPer lessons-learned.md: When modifying agent toolsets, verify frontmatter includes required tools. This task doesn't modify agents, but if we add a new tool dependency (like yq for YAML parsing), ensure it's available in the sandbox image or use a fallback (grep/awk/python).\n\n## Alternative considered: Multiple Dockerfiles\nCould create Dockerfile.ruby-3.2, Dockerfile.ruby-3.3, etc. Rejected because:\n- Violates DRY - duplicates 90% of content\n- Harder to maintain (bug fixes need 3 changes)\n- Build args are designed for this exact use case\n\n## Config format\n```yaml\n# ruby-versions.yaml\nversions:\n  \"3.2\": \"3.2.6\"\n  \"3.3\": \"3.3.6\"\n  \"3.4\": \"3.4.7\"\ndefault: \"3.4\"\n```\n\n## Detection logic pseudocode\n```bash\nauto_detect_ruby_version() {\n  # 1. Check if .ruby-version exists in repo\n  if repo_is_local \u0026\u0026 .ruby-version exists locally; then\n    version=$(cat .ruby-version)\n  else\n    # Shallow clone to read .ruby-version\n    version=$(git archive --remote=REPO_URL HEAD .ruby-version | tar -xO 2\u003e/dev/null)\n  fi\n  \n  # 2. Extract major.minor (e.g., \"3.3.1\" -\u003e \"3.3\")\n  major_minor=$(echo \"$version\" | grep -oE '^[0-9]+\\.[0-9]+')\n  \n  # 3. Validate against ruby-versions.yaml\n  if version_exists_in_config \"$major_minor\"; then\n    export IMAGE_TAG=\"ruby-$major_minor\"\n  else\n    error \"Ruby $major_minor not supported. Supported: $(list_versions)\"\n    exit 1\n  fi\n}\n```\n\n## Build output example\n```\n[claude-sandbox] Building Ruby 3.2.6...\n[claude-sandbox] Tagging as claude-sandbox:ruby-3.2\n[claude-sandbox] Building Ruby 3.3.6...\n[claude-sandbox] Tagging as claude-sandbox:ruby-3.3\n[claude-sandbox] Building Ruby 3.4.7...\n[claude-sandbox] Tagging as claude-sandbox:ruby-3.4\n[claude-sandbox] Tagging claude-sandbox:ruby-3.4 as claude-sandbox:latest\n[claude-sandbox] Build complete - 4 images created\n```\n\n## Notes for implementer\n- The .ruby-version detection is the trickiest part. It needs to happen BEFORE the container starts, but the file is in the repo. Consider using `git archive` for remote repos or direct read for local paths.\n- Keep the build script simple. If YAML parsing becomes complex, consider falling back to a simple format like `.ini` or even a shell script that sets variables.\n- Test the git archive approach first - it's cleaner than doing a shallow clone just to read one file.\n- The default version in config should be the same as the current hardcoded version (3.4.7) to avoid surprises.\n- Consider adding a `--ruby-version` flag to bin/claude-sandbox for manual override, useful for testing.","created_at":"2026-02-01T04:41:34Z"}]}
{"id":".claude-yad.2","title":"Implement multi-Ruby support","status":"open","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-01T05:39:03.514082+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-01T05:39:03.514082+01:00","dependencies":[{"issue_id":".claude-yad.2","depends_on_id":".claude-yad","type":"parent-child","created_at":"2026-02-01T05:39:03.514757+01:00","created_by":"Tomáš Landovský"},{"issue_id":".claude-yad.2","depends_on_id":".claude-yad.3","type":"blocks","created_at":"2026-02-01T05:39:06.557402+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-yad.3","title":"Review implementation","status":"open","priority":1,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-02-01T05:39:03.590669+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-01T05:39:03.590669+01:00","dependencies":[{"issue_id":".claude-yad.3","depends_on_id":".claude-yad","type":"parent-child","created_at":"2026-02-01T05:39:03.591319+01:00","created_by":"Tomáš Landovský"}]}
{"id":".claude-yrq","title":"Add a comment to this task and mark it closed","status":"closed","priority":2,"issue_type":"task","owner":"landovsky@gmail.com","created_at":"2026-01-31T16:20:45.547612+01:00","created_by":"Tomáš Landovský","updated_at":"2026-01-31T17:28:23.764437+01:00","closed_at":"2026-01-31T17:28:23.764437+01:00","close_reason":"Closed","comments":[{"id":14,"issue_id":".claude-yrq","author":"Tomáš Landovský","text":"Task completed via /develop command. Added this comment and marking as done.","created_at":"2026-01-31T15:28:00Z"},{"id":15,"issue_id":".claude-yrq","author":"Claude (Sandbox)","text":"Task processed and completed. Marking as done.","created_at":"2026-01-31T15:52:01.275743965Z"}]}
