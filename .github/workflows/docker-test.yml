name: Test Docker Build

# Run on PRs that modify Docker-related files
# This catches build issues before merging
on:
  pull_request:
    paths:
      - 'claude-sandbox/Dockerfile'
      - 'claude-sandbox/entrypoint.sh'
      - 'claude-sandbox/safe-git'
      - 'claude-sandbox/notify-telegram.sh'
      - 'claude-sandbox/docker-compose.yml'
      - '.github/workflows/docker-*.yml'

# Minimal permissions - only what's needed for checkout
permissions:
  contents: read

jobs:
  test-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare claude-config directory
        working-directory: ./claude-sandbox
        run: |
          # Create claude-config structure for test builds
          # Copy agents, artifacts, and commands from the repository
          mkdir -p claude-config/agents
          mkdir -p claude-config/artifacts
          mkdir -p claude-config/commands

          # Copy agents from repository
          if [ -d "../agents" ] && [ -n "$(ls -A ../agents 2>/dev/null)" ]; then
            echo "Copying agents from repository..."
            cp -r ../agents/* claude-config/agents/
            echo "Agents copied: $(ls -1 claude-config/agents/ | wc -l) files"
          else
            echo "No agents found in repository"
          fi

          # Copy artifacts from repository
          if [ -d "../artifacts" ] && [ -n "$(ls -A ../artifacts 2>/dev/null)" ]; then
            echo "Copying artifacts from repository..."
            cp -r ../artifacts/* claude-config/artifacts/
            echo "Artifacts copied"
          else
            echo "No artifacts found in repository"
          fi

          # Copy commands from repository
          if [ -d "../commands" ] && [ -n "$(ls -A ../commands 2>/dev/null)" ]; then
            echo "Copying commands from repository..."
            cp -r ../commands/* claude-config/commands/
            echo "Commands copied: $(ls -1 claude-config/commands/ | wc -l) files"
          else
            echo "No commands found in repository"
          fi

          # Create minimal settings.json
          cat > claude-config/settings.json << 'EOF'
          {
            "permissions": {
              "allow": [],
              "deny": []
            }
          }
          EOF

          echo "✓ Claude config prepared for test build"

      - name: Test Docker build
        uses: docker/build-push-action@v5
        with:
          context: ./claude-sandbox
          push: false
          tags: claude-sandbox:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build successful
        run: echo "✓ Docker build completed successfully"
