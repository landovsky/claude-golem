# Context: Fix inter-stage data passing in development workflow

## Request summary
The multi-stage workflow (analyst -> planner -> implementer -> reviewer) fails reliably at file-based handoffs between stages. Each stage is a sub-agent spawned via the Task tool. Sub-agents write output files (specs, plans, etc.) that downstream agents need to read. In practice across 10 test runs, this breaks frequently. The user proposes switching to bd comments as the transport mechanism.

## Root cause analysis

The failure stems from how Claude Code's Task tool works. When master spawns a sub-agent via Task:

1. **CWD reset**: Each sub-agent's bash calls have their CWD reset between invocations. The agent instructions even warn about this ("Agent threads always have their cwd reset between bash calls"). If an agent uses relative paths, file writes may land in unexpected locations.

2. **Tool availability mismatch**: The agent definitions specify different tool sets. The planner has `Read, Glob, Grep` but NOT `Write` or `Bash`. It cannot create files via the Write tool. It must use Read-only tools. Yet its instructions say "Write the plan - create `.claude/plans/[issue-id]-plan.md`". This is a direct contradiction -- the planner literally cannot produce its expected output with its declared toolset.

3. **File existence validation is fragile**: Master validates output by running `test -f .claude/specs/[issue-id]-spec.md`. But if the sub-agent wrote to a slightly different path (absolute vs relative, wrong CWD), the file exists but master checks the wrong location.

4. **No guaranteed write-back**: Sub-agents return text to the master when they complete. But the workflow ignores this return value and instead relies on side-effect files.

## Relevant code areas
- `/Users/tomas/.claude/agents/master.md` - Orchestrator; lines 142-175 show output validation pattern (file existence checks)
- `/Users/tomas/.claude/agents/planner.md` - Frontmatter declares `tools: Read, Glob, Grep` (NO Write tool) but instructions require writing a plan file
- `/Users/tomas/.claude/agents/analyst.md` - Has `tools: Read, Write, Glob, Grep, WebFetch` (has Write)
- `/Users/tomas/.claude/agents/implementer.md` - Has `tools: Read, Write, Edit, Bash, Glob, Grep` (has Write)
- `/Users/tomas/.claude/agents/reviewer.md` - Has `tools: Read, Write, Edit, Bash, Glob, Grep` (has Write)
- `/Users/tomas/.claude/artifacts/workflow-design/WORKFLOW.md` - Documents the file-based handoff architecture

## Existing patterns to follow
- All agents already use `bd` CLI for status updates (`bd close`, `bd update`, `bd comments add`)
- The reviewer already uses `bd show [issue-id]` to read implementer notes
- Comments are already used for blocker reasons

## Technical constraints
- Task tool sub-agents return their final text output to the caller -- this is the most reliable data channel
- bd CLI is available and already a dependency
- bd comment size limits are unknown (need to test)
- Planner agent currently lacks Write tool, making file output impossible for that agent

## Edge cases to address
- Large outputs (specs/plans can be 100+ lines of markdown) -- may exceed bd comment size limits
- Multiple stages writing to same task vs separate subtasks
- Reading the right comment when a task has multiple comments
- Agent must know its own subtask ID and sibling subtask IDs

## Risks
- bd comments may have size limits that truncate large specs/plans
- Switching transport mechanism requires updating all 5 agent definitions + WORKFLOW.md
- If bd is unavailable or errors, the entire workflow stops (single point of failure)
- Return-value approach (option B) adds token cost since master must hold all context
