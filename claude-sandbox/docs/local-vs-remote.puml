@startuml claude-sandbox-local-vs-remote
!define LIGHTGREEN #E0FFE0
!define LIGHTBLUE #E0F0FF

title Claude Sandbox - Local vs Remote Execution

left to right direction

' ========================
' LOCAL EXECUTION
' ========================
package "LOCAL EXECUTION\n(Docker Compose)" as local LIGHTGREEN {
    node "User Machine" {
        component "CLI" as cli_local [
            **claude-sandbox local**
            ====
            Auto-detect:
            • REPO_URL
            • REPO_BRANCH
            • RUBY_VERSION
            • Services needed
        ]

        component "detect-services.sh" as detect_local
    }

    node "Docker Engine" {
        node "Docker Network\n(bridge)" {
            rectangle "Main Container" as container_local {
                component "claude:ruby-3.4" as image_local
                component "entrypoint.sh" as entry_local
                component "Claude CLI" as claude_local
                storage "/workspace" as ws_local
                storage "vendor/bundle" as bundle_local
            }

            database "postgres-sidecar" as pg_local [
                **postgis:16-3.4-alpine**
                ----
                Profile: with-postgres
                Port: 5432
                Volume: postgres_data
            ]

            database "redis-sidecar" as redis_local [
                **redis:7-alpine**
                ----
                Profile: with-redis
                Port: 6379
            ]

            database "mysql-sidecar" as mysql_local [
                **mysql:8.0**
                ----
                Profile: with-mysql
                Port: 3306
            ]
        }
    }

    note right of container_local
        **Networking:**
        • Service discovery via container names
        • DATABASE_URL=postgis://...@postgres:5432/...
        • REDIS_URL=redis://redis:6379

        **Volumes:**
        • claude_workspace (persisted across runs)
        • postgres_data (database persistence)

        **Health Checks:**
        • Defined in docker-compose.yml
        • pg_isready (5s interval, 5 retries)
        • redis-cli ping (5s interval, 5 retries)
    end note
}

' ========================
' REMOTE EXECUTION
' ========================
package "REMOTE EXECUTION\n(Kubernetes)" as remote LIGHTBLUE {
    node "User Machine" {
        component "CLI" as cli_remote [
            **claude-sandbox remote**
            ====
            Auto-detect:
            • REPO_URL
            • REPO_BRANCH
            • RUBY_VERSION
            • Services needed
        ]

        component "detect-services.sh" as detect_remote
        component "generate_k8s_job_yaml()" as gen_yaml
    }

    cloud "Kubernetes Cluster" {
        node "Job: claude-sandbox-YYYYMMDD-HHMMSS" {
            rectangle "Pod" {
                rectangle "Main Container" as container_remote {
                    component "landovsky/claude-sandbox:ruby-3.4" as image_remote
                    component "entrypoint.sh" as entry_remote
                    component "Claude CLI" as claude_remote
                    storage "/workspace" as ws_remote
                    storage "/dev/shm (2Gi)" as shm_remote
                    storage "/secrets" as secrets_remote
                }

                database "postgres-sidecar\n[CONDITIONAL]" as pg_remote [
                    **postgis:16-3.4-alpine**
                    ----
                    Condition: needs_postgres=true
                    Resources: 256-512Mi, 100-500m CPU
                    Volume: /workspace/postgres
                ]

                database "redis-sidecar\n[CONDITIONAL]" as redis_remote [
                    **redis:7-alpine**
                    ----
                    Condition: needs_redis=true
                    Resources: 64-128Mi, 50-200m CPU
                ]

                database "mysql-sidecar\n[CONDITIONAL]" as mysql_remote [
                    **mysql:8.0**
                    ----
                    Condition: needs_mysql=true
                    Resources: 256-512Mi, 100-500m CPU
                ]
            }

            storage "K8s Secrets" as k8s_secrets [
                **claude-sandbox-secrets**
                ====
                • GITHUB_TOKEN
                • CLAUDE_CODE_OAUTH_TOKEN
                • ANTHROPIC_API_KEY
                • TELEGRAM_BOT_TOKEN
                • TELEGRAM_CHAT_ID
            ]

            storage "age-key Secret" as age_secret [
                **claude-sandbox-age-key**
                ====
                age private key
                for .env.sops decryption
            ]
        }
    }

    note right of container_remote
        **Networking:**
        • All containers in same Pod
        • localhost networking
        • DATABASE_URL=postgis://...@localhost:5432/...
        • REDIS_URL=redis://localhost:6379

        **Volumes:**
        • workspace: emptyDir (ephemeral)
        • dshm: emptyDir Memory (2Gi)
        • age-key: secret (optional)

        **Readiness:**
        • Entrypoint checks with retries
        • pg_isready (30 retries, 1s interval)
        • redis-cli ping (30 retries, 1s interval)

        **Job Config:**
        • TTL: 3600s (auto-cleanup)
        • BackoffLimit: 0 (no retry)
        • RestartPolicy: Never
    end note
}

' ========================
' EXTERNAL SERVICES (SHARED)
' ========================
cloud "GitHub" as github
cloud "Telegram" as telegram
cloud "Docker Registry" as registry

' Local connections
cli_local --> detect_local
cli_local --> container_local : docker compose run
container_local --> pg_local : depends_on
container_local --> redis_local : depends_on
container_local --> mysql_local : depends_on
entry_local --> claude_local : exec

' Remote connections
cli_remote --> detect_remote
cli_remote --> gen_yaml
cli_remote --> container_remote : kubectl apply
gen_yaml --> k8s_secrets : references
gen_yaml --> age_secret : references
container_remote --> pg_remote : same Pod
container_remote --> redis_remote : same Pod
container_remote --> mysql_remote : same Pod
k8s_secrets --> container_remote : envFrom
age_secret --> secrets_remote : volumeMount
entry_remote --> claude_remote : exec

' Shared external connections
claude_local ..> github : push/pull
claude_remote ..> github : push/pull
claude_local ..> telegram : notify
claude_remote ..> telegram : notify
image_local <.. registry : pull
image_remote <.. registry : pull

' ========================
' COMPARISON TABLE
' ========================
legend right
    |= Aspect |= Local (Docker Compose) |= Remote (Kubernetes) |
    | **Use Case** | Development, testing | Production, isolation |
    | **Service Discovery** | Container names (DNS) | localhost (same Pod) |
    | **Persistence** | Volumes (named) | emptyDir (ephemeral) |
    | **Resource Limits** | None (host limits) | Explicit (requests/limits) |
    | **Secrets** | .env files + SOPS | K8s Secrets + SOPS |
    | **Cleanup** | Manual (docker compose down) | Auto (TTL: 3600s) |
    | **Networking** | Bridge network | Pod network |
    | **Sidecars** | Profile-based | Conditional YAML gen |
    | **Image Source** | Local build | Registry pull |
    | **Logs** | docker compose logs | kubectl logs |
    | **Scalability** | Single machine | Cluster resources |
    | **Cost** | Free (local) | Cluster costs |

    **Common Elements:**
    • Same container image (claude-sandbox:ruby-X.Y)
    • Same entrypoint.sh bootstrap logic
    • Same Claude CLI execution
    • Same safe-git protections
    • Same Telegram notifications
    • Same service detection mechanism
endlegend

@enduml
