#!/bin/bash
# claude-sandbox - Run Claude Code in an isolated Docker environment
#
# Usage:
#   claude-sandbox local "work on task 123"    # Run locally with Docker Compose
#   claude-sandbox remote "work on task 123"   # Run on k8s cluster
#   claude-sandbox build                       # Build the Docker image
#   claude-sandbox push                        # Push image to registry
#
# Required environment variables:
#   GITHUB_TOKEN              - GitHub token for cloning
#   CLAUDE_CODE_OAUTH_TOKEN   - OAuth token from `claude setup-token` (valid 1 year)
#                               OR use ANTHROPIC_API_KEY instead
#   REPO_URL                  - Repository URL to clone
#
# Optional environment variables:
#   ANTHROPIC_API_KEY   - Alternative to OAuth token (pay-as-you-go API)
#   TELEGRAM_BOT_TOKEN  - Telegram bot token for notifications
#   TELEGRAM_CHAT_ID    - Telegram chat ID for notifications
#   REPO_BRANCH         - Branch to start from (default: main)
#   CLAUDE_IMAGE        - Docker image for k8s (default: claude-sandbox:latest)

set -e

# Find the sandbox installation directory
# Try: script's parent dir (backward compat), then ~/.claude/claude-sandbox (global install)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CANDIDATE_DIR="$(dirname "$SCRIPT_DIR")"

if [ -f "$CANDIDATE_DIR/docker-compose.yml" ]; then
  # Called from bin/ subdirectory (backward compatible)
  SANDBOX_DIR="$CANDIDATE_DIR"
elif [ -f "$HOME/.claude/claude-sandbox/docker-compose.yml" ]; then
  # Global installation
  SANDBOX_DIR="$HOME/.claude/claude-sandbox"
else
  echo -e "\033[0;31m[claude-sandbox]\033[0m Cannot find claude-sandbox installation" >&2
  echo -e "\033[0;31m[claude-sandbox]\033[0m Expected docker-compose.yml in:" >&2
  echo -e "\033[0;31m[claude-sandbox]\033[0m   - $CANDIDATE_DIR" >&2
  echo -e "\033[0;31m[claude-sandbox]\033[0m   - $HOME/.claude/claude-sandbox" >&2
  exit 1
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[claude-sandbox]${NC} $1"; }
warn() { echo -e "${YELLOW}[claude-sandbox]${NC} $1"; }
error() { echo -e "${RED}[claude-sandbox]${NC} $1" >&2; }

# Auto-detect REPO_URL from current directory if not set
auto_detect_repo() {
  if [ -n "$REPO_URL" ]; then
    # Explicitly set, don't override
    return 0
  fi

  # Try to get git remote from current directory
  local detected_url=$(git -C "$PWD" remote get-url origin 2>/dev/null)
  if [ -z "$detected_url" ]; then
    error "REPO_URL not set and cannot auto-detect from current directory"
    error "Either:"
    error "  1. Run from a git repository with origin remote, or"
    error "  2. Set REPO_URL environment variable"
    return 1
  fi

  # Convert SSH URLs to HTTPS for token authentication
  # git@github.com:user/repo.git -> https://github.com/user/repo.git
  if [[ "$detected_url" =~ ^git@github\.com:(.+)$ ]]; then
    detected_url="https://github.com/${BASH_REMATCH[1]}"
    log "Converted SSH URL to HTTPS for token authentication"
  fi

  export REPO_URL="$detected_url"
  log "Auto-detected REPO_URL: $REPO_URL"
}

# Auto-detect REPO_BRANCH from current directory if not set
auto_detect_branch() {
  if [ -n "$REPO_BRANCH" ]; then
    # Explicitly set, don't override
    return 0
  fi

  # Try to get current branch from current directory
  local detected_branch=$(git -C "$PWD" branch --show-current 2>/dev/null)
  if [ -n "$detected_branch" ]; then
    export REPO_BRANCH="$detected_branch"
    log "Auto-detected REPO_BRANCH: $REPO_BRANCH"
  else
    # Default to main (already handled by entrypoint.sh default)
    log "Using default branch: main"
  fi
}

# Extract repository owner from git remote origin
# Handles both SSH (git@github.com:owner/repo.git) and HTTPS (https://github.com/owner/repo.git)
get_repo_owner() {
  local git_dir="${1:-.}"
  local remote_url=$(git -C "$git_dir" remote get-url origin 2>/dev/null)
  if [ -z "$remote_url" ]; then
    echo ""
    return 1
  fi

  # Extract owner from both formats
  # SSH: git@github.com:owner/repo.git -> owner
  # HTTPS: https://github.com/owner/repo.git -> owner
  echo "$remote_url" | sed -E 's|^git@github\.com:([^/]+)/.*|\1|; s|^https://github\.com/([^/]+)/.*|\1|'
}

usage() {
  cat <<EOF
Usage: claude-sandbox <command> [options]

Commands:
  local <task>     Run Claude locally with Docker Compose
  remote <task>    Run Claude on k8s cluster
  build            Build the Docker image
  push             Push image to registry
  logs             Follow logs of running k8s job
  clean            Clean up completed k8s jobs

Examples:
  claude-sandbox local "fix the login bug"
  claude-sandbox remote "implement feature X"
  claude-sandbox build

Environment variables:
  GITHUB_TOKEN, REPO_URL (required)
  CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY (one required)
  TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID (optional, for notifications)
  REPO_BRANCH (optional, default: main)
  CLAUDE_IMAGE (optional, for remote)

To get OAuth token (uses your Claude subscription):
  claude setup-token
EOF
}

check_env() {
  local missing=0

  # Auto-detect repository context
  auto_detect_repo || missing=1
  auto_detect_branch

  # Required vars (REPO_URL may have been auto-detected)
  for var in GITHUB_TOKEN REPO_URL; do
    if [ -z "${!var}" ]; then
      error "Missing required environment variable: $var"
      missing=1
    fi
  done

  # Need either OAuth token or API key
  if [ -z "$CLAUDE_CODE_OAUTH_TOKEN" ] && [ -z "$ANTHROPIC_API_KEY" ]; then
    error "Either CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY is required"
    error "Get OAuth token with: claude setup-token"
    missing=1
  fi

  if [ $missing -eq 1 ]; then
    exit 1
  fi

  # Warn about optional vars
  if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
    warn "Telegram not configured - notifications disabled"
  fi
}

cmd_local() {
  local task="$*"
  if [ -z "$task" ]; then
    error "Task is required"
    usage
    exit 1
  fi

  check_env

  log "Starting local sandbox..."
  log "Task: $task"

  cd "$SANDBOX_DIR"

  # Check if image exists
  if ! docker images --format '{{.Repository}}:{{.Tag}}' | grep -q "^claude-sandbox:latest$"; then
    error "Image not found. Run 'bin/claude-sandbox build' first."
    exit 1
  fi

  # Run with task
  docker compose run --rm \
    -e TASK="$task" \
    -e GITHUB_TOKEN="$GITHUB_TOKEN" \
    -e CLAUDE_CODE_OAUTH_TOKEN="${CLAUDE_CODE_OAUTH_TOKEN:-}" \
    -e ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
    -e REPO_URL="$REPO_URL" \
    -e REPO_BRANCH="${REPO_BRANCH:-main}" \
    -e TELEGRAM_BOT_TOKEN="${TELEGRAM_BOT_TOKEN:-}" \
    -e TELEGRAM_CHAT_ID="${TELEGRAM_CHAT_ID:-}" \
    claude
}

cmd_remote() {
  local task="$*"
  if [ -z "$task" ]; then
    error "Task is required"
    usage
    exit 1
  fi

  check_env

  # Check kubectl is available
  if ! command -v kubectl &> /dev/null; then
    error "kubectl not found - required for remote execution"
    exit 1
  fi

  # Check cluster connection
  if ! kubectl cluster-info &> /dev/null; then
    error "Cannot connect to k8s cluster"
    exit 1
  fi

  # Generate unique job name with random suffix to prevent collisions
  local random_suffix=$(head /dev/urandom | tr -dc a-z0-9 | head -c 4)
  local job_name="claude-sandbox-$(date +%Y%m%d-%H%M%S)-${random_suffix}"

  log "Creating k8s job: $job_name"
  log "Task: $task"
  log "Repository: $REPO_URL"
  log "Branch: ${REPO_BRANCH:-main}"

  # Export for envsubst
  export TASK="$task"
  export JOB_NAME="$job_name"

  # Auto-detect CLAUDE_IMAGE from git remote origin owner if not set
  if [ -z "$CLAUDE_IMAGE" ]; then
    local owner=$(get_repo_owner "$SANDBOX_DIR")
    if [ -n "$owner" ]; then
      export CLAUDE_IMAGE="${owner}/claude-sandbox:latest"
      log "Auto-detected CLAUDE_IMAGE: $CLAUDE_IMAGE"
    else
      # Fallback to original hardcoded value if can't detect
      export CLAUDE_IMAGE="landovsky/claude-sandbox:latest"
      warn "Could not detect repository owner, using default: $CLAUDE_IMAGE"
    fi
  fi

  export REPO_URL="$REPO_URL"
  export REPO_BRANCH="${REPO_BRANCH:-main}"

  # Apply job
  envsubst < "$SANDBOX_DIR/k8s/job-template.yaml" | kubectl apply -f -

  log "Job created successfully"
  log "Watch logs with: kubectl logs -f job/$job_name"
  log "Or run: claude-sandbox logs"
}

cmd_build() {
  log "Building Docker image..."
  cd "$SANDBOX_DIR"

  # Copy Claude config (agents, settings) to build context
  local claude_config="$SANDBOX_DIR/claude-config"
  rm -rf "$claude_config"
  mkdir -p "$claude_config"

  # Copy agents if they exist
  if [ -d "$HOME/.claude/agents" ]; then
    log "Copying agents from ~/.claude/agents/"
    cp -r "$HOME/.claude/agents" "$claude_config/"
  else
    warn "No agents found at ~/.claude/agents/"
    mkdir -p "$claude_config/agents"
  fi

  # Copy artifacts if they exist
  if [ -d "$HOME/.claude/artifacts" ]; then
    log "Copying artifacts from ~/.claude/artifacts/"
    cp -r "$HOME/.claude/artifacts" "$claude_config/"
  fi

  # Copy custom commands if they exist
  if [ -d "$HOME/.claude/commands" ]; then
    log "Copying commands from ~/.claude/commands/"
    cp -r "$HOME/.claude/commands" "$claude_config/"
  fi

  # Create a minimal settings.json for the sandbox
  # (don't copy host settings - they may have paths that don't work in container)
  cat > "$claude_config/settings.json" << 'EOF'
{
  "permissions": {
    "allow": [],
    "deny": []
  }
}
EOF

  log "Building image..."
  docker build -t claude-sandbox:latest .

  # Clean up copied config but keep .gitkeep so docker compose doesn't fail
  find "$claude_config" -type f ! -name '.gitkeep' -delete
  find "$claude_config" -mindepth 1 -type d -delete 2>/dev/null || true

  log "Build complete"
}

cmd_push() {
  local registry="${CLAUDE_REGISTRY:-}"
  if [ -z "$registry" ]; then
    error "CLAUDE_REGISTRY environment variable required"
    error "Example: export CLAUDE_REGISTRY=ghcr.io/username"
    exit 1
  fi

  local image="$registry/claude-sandbox:latest"
  log "Pushing to $image..."

  docker tag claude-sandbox:latest "$image"
  docker push "$image"

  log "Push complete"
  log "Update CLAUDE_IMAGE=$image for remote runs"
}

cmd_logs() {
  # Find most recent job
  local job=$(kubectl get jobs -l app=claude-sandbox \
    --sort-by=.metadata.creationTimestamp \
    -o jsonpath='{.items[-1].metadata.name}' 2>/dev/null)

  if [ -z "$job" ]; then
    error "No claude-sandbox jobs found"
    exit 1
  fi

  log "Following logs for job: $job"
  kubectl logs -f "job/$job" -c claude
}

cmd_clean() {
  log "Cleaning up completed jobs..."
  kubectl delete jobs -l app=claude-sandbox,managed-by=claude-sandbox-cli \
    --field-selector status.successful=1 2>/dev/null || true
  kubectl delete jobs -l app=claude-sandbox,managed-by=claude-sandbox-cli \
    --field-selector status.failed=1 2>/dev/null || true
  log "Cleanup complete"
}

# Main
case "${1:-}" in
  local)
    shift
    cmd_local "$@"
    ;;
  remote)
    shift
    cmd_remote "$@"
    ;;
  build)
    cmd_build
    ;;
  push)
    cmd_push
    ;;
  logs)
    cmd_logs
    ;;
  clean)
    cmd_clean
    ;;
  -h|--help|help|"")
    usage
    ;;
  *)
    error "Unknown command: $1"
    usage
    exit 1
    ;;
esac
