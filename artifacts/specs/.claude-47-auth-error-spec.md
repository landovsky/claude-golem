# Spec: Surface Authentication Errors in Claude Sandbox

## Summary

Authentication failures from the Claude CLI are silently swallowed by the jq filter in entrypoint.sh. Users see no output when authentication fails, only discovering the issue through a non-zero exit code. The fix requires modifying the output pipeline to display error events alongside text content.

## Root Cause Analysis

### The Problem Pipeline

```bash
# Current implementation (entrypoint.sh line 253-257)
exec claude --dangerously-skip-permissions -p "$TASK" \
  --output-format stream-json \
  --verbose \
  --include-partial-messages | \
  jq -rj 'select(.type == "stream_event" and .event.delta.type? == "text_delta") | .event.delta.text'
```

This jq filter **only** passes through events where:
- `type == "stream_event"`
- AND `event.delta.type == "text_delta"`

Authentication errors are NOT text_delta events - they use different event types (likely `error` or `system` events). The filter silently drops them.

### Why Pre-flight Checks Don't Help

The entrypoint.sh validates that auth environment variables ARE SET (lines 49-54):
```bash
if [ -z "$CLAUDE_CODE_OAUTH_TOKEN" ] && [ -z "$ANTHROPIC_API_KEY" ]; then
  error "Either CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY is required"
  exit 1
fi
```

But this only checks if a value exists, not if it's VALID. An invalid or expired token passes this check.

### What the User Experiences

| Scenario | Pre-flight Check | Claude CLI Output | User Sees |
|----------|------------------|-------------------|-----------|
| No token set | FAIL - shows error | N/A | Error message |
| Invalid token | PASS | Error event (filtered out) | Nothing |
| Expired token | PASS | Error event (filtered out) | Nothing |
| Valid token | PASS | text_delta events | Claude output |

## Authentication Flow Diagram

```
User runs: bin/claude-sandbox local "task"
    |
    v
check_env() validates CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY is SET
    |
    v
docker compose run claude
    |
    v
entrypoint.sh validates env var exists (not validity)
    |
    v
exec claude -p "$TASK" --output-format stream-json | jq 'text_delta filter'
    |
    +---> Valid token: Claude streams text_delta events --> User sees output
    |
    +---> Invalid token: Claude emits error event --> jq filter drops it --> User sees nothing
                                                                              |
                                                                              v
                                                                        Non-zero exit code
                                                                              |
                                                                              v
                                                                        cleanup() shows "Session ended with exit code: N"
                                                                        notify-telegram.sh sends "Failed (exit code: N)"
```

## Requirements

- [ ] Error events from Claude CLI must be displayed to users
- [ ] Text streaming (text_delta) must continue to work as before
- [ ] Exit code and error message should both be visible
- [ ] Error messages should be distinguishable from normal output (e.g., color-coded)
- [ ] Telegram notifications should include error details when available

## Edge Cases

- [ ] Multiple error events in a single response - all should be shown
- [ ] Error event followed by recovery (if possible) - both should be visible
- [ ] Non-authentication errors (rate limits, network errors) - should also surface
- [ ] Malformed JSON in stream - should not crash the filter, should show raw output

## Acceptance Criteria

- [ ] Running with invalid ANTHROPIC_API_KEY shows "Invalid API key" (or similar) to user
- [ ] Running with expired CLAUDE_CODE_OAUTH_TOKEN shows expiration message to user
- [ ] Normal successful operation still streams text as before
- [ ] Exit code is non-zero when authentication fails
- [ ] Error output goes to stderr (not mixed with stdout content)
- [ ] Telegram notification includes error reason, not just exit code

## Out of Scope

- Token validity pre-flight check (would require API call, adds latency)
- Automatic token refresh for expired OAuth tokens
- Credential storage or management
- Changes to the Claude CLI itself

## Technical Approach Options

### Option A: Dual jq filters with tee
Stream to two jq processes - one for text_delta, one for errors:
```bash
claude ... | tee >(jq 'select error events' >&2) | jq 'select text_delta events'
```
**Pro**: Clean separation. **Con**: Complex process substitution, error timing may be off.

### Option B: Single expanded jq filter
Modify jq to handle both event types:
```bash
jq -rj 'if .type == "error" then "[ERROR] " + .message + "\n" | @text
       elif .type == "stream_event" and .event.delta.type? == "text_delta" then .event.delta.text
       else empty end'
```
**Pro**: Single process. **Con**: Need to know exact error event structure.

### Option C: Wrapper script with parsing
Replace jq with a small script (bash or awk) that handles both paths:
```bash
claude ... | while read -r line; do
  type=$(echo "$line" | jq -r '.type // empty')
  case "$type" in
    error|system) echo "$line" | jq -r '.message' >&2 ;;
    stream_event) echo "$line" | jq -rj 'select(.event.delta.type? == "text_delta") | .event.delta.text' ;;
  esac
done
```
**Pro**: Most flexible. **Con**: Per-line jq invocation is slow.

### Option D: Capture error in cleanup (less preferred)
Store full output to temp file, parse errors on exit:
**Con**: Delays error display until end, loses streaming benefit.

## Investigation Needed

Before implementing, the planner/implementer should:

1. **Capture actual error event format**: Run `claude -p "test" --output-format stream-json` with an invalid key (without jq filter) to see the exact JSON structure of error events.

2. **Identify all error event types**: May include `error`, `system`, or others.

3. **Test edge cases**: Rate limits, network errors, malformed input.

## Artifacts Consulted

- `artifacts/workflow-design/WORKFLOW.md`: Confirmed this is a full-workflow task requiring analyst/planner/implementer/reviewer stages.
- `artifacts/lessons-learned.md`: No directly applicable lessons, but noted the importance of toolset verification (not directly relevant here since this is shell scripting).

## Artifacts to Update

- `artifacts/lessons-learned.md`: After implementation, document the error event structure discovered and the chosen approach, for future reference.

## Open Risks

1. **Unknown error event JSON structure**: The exact format of Claude CLI error events is not documented. Implementation may need to adjust once the actual format is observed.

2. **Multiple error event types**: Different failure modes (invalid key vs expired token vs rate limit) may use different event types or message formats.

3. **jq performance**: Depending on approach chosen, per-line jq invocation could add latency to streaming output.
